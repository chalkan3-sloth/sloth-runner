package agent

import (
	"database/sql"
	"fmt"

	"github.com/chalkan3-sloth/sloth-runner/internal/config"
	_ "github.com/mattn/go-sqlite3"
)

// Agent represents agent information
type Agent struct {
	ID      int
	Name    string
	Address string
	Status  string
}

// findAgentByName finds an agent by name in the local database
func findAgentByName(name string) (*Agent, error) {
	dbPath := config.GetAgentDBPath()

	db, err := sql.Open("sqlite3", dbPath)
	if err != nil {
		return nil, fmt.Errorf("failed to open database: %w", err)
	}
	defer db.Close()

	var agent Agent
	query := `SELECT id, name, address, status FROM agents WHERE name = ? LIMIT 1`

	err = db.QueryRow(query, name).Scan(&agent.ID, &agent.Name, &agent.Address, &agent.Status)
	if err == sql.ErrNoRows {
		return nil, fmt.Errorf("agent '%s' not found", name)
	}
	if err != nil {
		return nil, fmt.Errorf("failed to query agent: %w", err)
	}

	return &agent, nil
}
