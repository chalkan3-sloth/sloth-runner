<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Executions - Sloth Runner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/theme.css">
    <link rel="stylesheet" href="/static/css/sloth-theme.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-lightning-charge-fill"></i> Sloth Runner
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/agents">Agents</a></li>
                    <li class="nav-item"><a class="nav-link" href="/workflows">Workflows</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/executions">Executions</a></li>
                    <li class="nav-item"><a class="nav-link" href="/hooks">Hooks</a></li>
                    <li class="nav-item"><a class="nav-link" href="/scheduler">Scheduler</a></li>
                    <li class="nav-item"><a class="nav-link" href="/metrics">Metrics</a></li>
                    <li class="nav-item"><a class="nav-link" href="/terminal">Terminal</a></li>
                </ul>
                <button class="theme-toggle" onclick="themeManager.toggle()">
                    <i class="bi bi-moon-stars-fill"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-play-circle"></i> Execute Workflow</h5>
                    </div>
                    <div class="card-body">
                        <form id="executeForm">
                            <div class="mb-3">
                                <label class="form-label">Workflow</label>
                                <select class="form-select" id="workflowSelect" required>
                                    <option value="">Select workflow...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Delegate To (optional)</label>
                                <select class="form-select" id="delegateSelect">
                                    <option value="">Local execution</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Variables (JSON)</label>
                                <textarea class="form-control" id="variablesInput" rows="3" placeholder='{"key": "value"}'>{}</textarea>
                                <small class="text-muted">Optional workflow variables as JSON object</small>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-play-fill"></i> Execute
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Execution History</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="executionsList" style="max-height: 500px; overflow-y: auto;">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> Live Logs</h5>
                        <div id="executionControls" style="display: none;">
                            <button class="btn btn-sm btn-danger" id="cancelBtn">
                                <i class="bi bi-stop-circle"></i> Cancel
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="executionInfo" class="p-3 border-bottom bg-light" style="display: none;">
                            <div class="row">
                                <div class="col-md-3">
                                    <small class="text-muted">Workflow</small>
                                    <div id="infoWorkflow" class="fw-bold">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Status</small>
                                    <div id="infoStatus">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Started</small>
                                    <div id="infoStartTime">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Duration</small>
                                    <div id="infoDuration">-</div>
                                </div>
                            </div>
                        </div>
                        <div id="logsContainer" class="p-3 bg-dark text-light" style="height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 14px;">
                            <div class="text-muted text-center py-5">
                                <i class="bi bi-info-circle fs-1"></i>
                                <p class="mt-3">Select an execution to view logs</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="logCount">0 lines</small>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="clearLogs()">
                                    <i class="bi bi-trash"></i> Clear
                                </button>
                                <button class="btn btn-outline-secondary" onclick="downloadLogs()">
                                    <i class="bi bi-download"></i> Download
                                </button>
                                <button class="btn btn-outline-secondary" id="autoScrollBtn" onclick="toggleAutoScroll()">
                                    <i class="bi bi-arrow-down-circle"></i> Auto-scroll: ON
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/websocket.js"></script>
    <script>
        let currentExecutionId = null;
        let autoScroll = true;
        let ws = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadWorkflows();
            await loadAgents();
            await loadExecutions();
            setupWebSocket();
            setupForm();
        });

        async function loadWorkflows() {
            try {
                const data = await API.get('/sloths');
                const select = document.getElementById('workflowSelect');
                select.innerHTML = '<option value="">Select workflow...</option>';
                data.sloths.forEach(sloth => {
                    if (sloth.active) {
                        select.innerHTML += `<option value="${sloth.name}">${sloth.name}</option>`;
                    }
                });
            } catch (error) {
                notify.error('Failed to load workflows');
            }
        }

        async function loadAgents() {
            try {
                const data = await API.get('/agents');
                const select = document.getElementById('delegateSelect');
                select.innerHTML = '<option value="">Local execution</option>';
                data.agents.forEach(agent => {
                    if (agent.status === 'connected') {
                        select.innerHTML += `<option value="${agent.name}">${agent.name}</option>`;
                    }
                });
            } catch (error) {
                console.error('Failed to load agents:', error);
            }
        }

        async function loadExecutions() {
            try {
                const data = await API.get('/executions');
                const list = document.getElementById('executionsList');

                if (!data.executions || data.executions.length === 0) {
                    list.innerHTML = '<div class="text-center py-4 text-muted">No executions yet</div>';
                    return;
                }

                list.innerHTML = data.executions.map(exec => {
                    const statusClass = exec.status === 'running' ? 'primary' :
                                       exec.status === 'completed' ? 'success' : 'danger';
                    const statusIcon = exec.status === 'running' ? 'arrow-repeat' :
                                      exec.status === 'completed' ? 'check-circle' : 'x-circle';

                    return `
                        <a href="#" class="list-group-item list-group-item-action" onclick="viewExecution('${exec.id}'); return false;">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h6 class="mb-1">
                                    <i class="bi bi-${statusIcon} text-${statusClass}"></i>
                                    ${exec.workflow_id}
                                </h6>
                                <small class="text-muted">${timeAgo(exec.start_time)}</small>
                            </div>
                            <div class="d-flex w-100 justify-content-between">
                                <small class="text-muted">ID: ${exec.id.substring(0, 8)}</small>
                                <span class="badge bg-${statusClass}">${exec.status}</span>
                            </div>
                        </a>
                    `;
                }).join('');
            } catch (error) {
                document.getElementById('executionsList').innerHTML =
                    '<div class="alert alert-danger m-3">Failed to load executions</div>';
            }
        }

        function setupForm() {
            document.getElementById('executeForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const workflow = document.getElementById('workflowSelect').value;
                const delegateTo = document.getElementById('delegateSelect').value;
                const variablesText = document.getElementById('variablesInput').value;

                let variables = {};
                try {
                    if (variablesText.trim()) {
                        variables = JSON.parse(variablesText);
                    }
                } catch (error) {
                    notify.error('Invalid JSON in variables field');
                    return;
                }

                try {
                    const data = await API.post('/executions', {
                        workflow_id: workflow,
                        delegate_to: delegateTo || undefined,
                        variables
                    });

                    notify.success('Workflow execution started!');
                    currentExecutionId = data.execution_id;
                    await loadExecutions();
                    await viewExecution(data.execution_id);
                } catch (error) {
                    notify.error('Failed to start execution');
                }
            });

            document.getElementById('cancelBtn').addEventListener('click', async () => {
                if (!currentExecutionId) return;

                try {
                    await API.post(`/executions/${currentExecutionId}/cancel`);
                    notify.success('Execution cancelled');
                } catch (error) {
                    notify.error('Failed to cancel execution');
                }
            });
        }

        function setupWebSocket() {
            ws = new WebSocketManager();
            ws.onMessage((data) => {
                if (data.type === 'execution_log' && data.execution_id === currentExecutionId) {
                    appendLog(data.log);
                } else if (data.type === 'execution_status' && data.execution_id === currentExecutionId) {
                    updateExecutionStatus(data);
                }
            });
        }

        async function viewExecution(id) {
            currentExecutionId = id;

            try {
                const data = await API.get(`/executions/${id}`);

                document.getElementById('executionInfo').style.display = 'block';
                document.getElementById('infoWorkflow').textContent = data.workflow_id;
                document.getElementById('infoStatus').innerHTML = getStatusBadge(data.status);
                document.getElementById('infoStartTime').textContent = formatDate(data.start_time);

                const duration = data.end_time ?
                    formatDuration((data.end_time - data.start_time) * 1000) :
                    'Running...';
                document.getElementById('infoDuration').textContent = duration;

                const logsContainer = document.getElementById('logsContainer');
                logsContainer.innerHTML = '';

                if (data.logs && data.logs.length > 0) {
                    data.logs.forEach(log => appendLog(log));
                }

                document.getElementById('executionControls').style.display =
                    data.status === 'running' ? 'block' : 'none';

            } catch (error) {
                notify.error('Failed to load execution details');
            }
        }

        function appendLog(logLine) {
            const logsContainer = document.getElementById('logsContainer');
            const logDiv = document.createElement('div');
            logDiv.textContent = logLine;
            logDiv.style.marginBottom = '2px';
            logsContainer.appendChild(logDiv);

            const count = logsContainer.children.length;
            document.getElementById('logCount').textContent = `${count} lines`;

            if (autoScroll) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }

        function clearLogs() {
            document.getElementById('logsContainer').innerHTML = '';
            document.getElementById('logCount').textContent = '0 lines';
        }

        function downloadLogs() {
            const logs = Array.from(document.getElementById('logsContainer').children)
                .map(div => div.textContent).join('\n');
            downloadFile(logs, `execution-${currentExecutionId}.log`, 'text/plain');
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('autoScrollBtn');
            btn.innerHTML = `<i class="bi bi-arrow-down-circle"></i> Auto-scroll: ${autoScroll ? 'ON' : 'OFF'}`;
        }

        function updateExecutionStatus(data) {
            document.getElementById('infoStatus').innerHTML = getStatusBadge(data.status);

            if (data.status !== 'running') {
                document.getElementById('executionControls').style.display = 'none';
                loadExecutions();
            }
        }

        function getStatusBadge(status) {
            const statusClass = status === 'running' ? 'primary' :
                               status === 'completed' ? 'success' : 'danger';
            const statusIcon = status === 'running' ? 'arrow-repeat' :
                              status === 'completed' ? 'check-circle' : 'x-circle';
            return `<span class="badge bg-${statusClass}"><i class="bi bi-${statusIcon}"></i> ${status}</span>`;
        }

        // Refresh executions list every 10 seconds
        setInterval(loadExecutions, 10000);
    </script>
</body>
</html>
