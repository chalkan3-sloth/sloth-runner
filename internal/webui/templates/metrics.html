<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Metrics - Sloth Runner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/theme.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/static/css/sloth-theme.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-lightning-charge-fill"></i> Sloth Runner
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/agents">Agents</a></li>
                    <li class="nav-item"><a class="nav-link" href="/workflows">Workflows</a></li>
                    <li class="nav-item"><a class="nav-link" href="/executions">Executions</a></li>
                    <li class="nav-item"><a class="nav-link" href="/hooks">Hooks</a></li>
                    <li class="nav-item"><a class="nav-link" href="/scheduler">Scheduler</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/metrics">Metrics</a></li>
                    <li class="nav-item"><a class="nav-link" href="/terminal">Terminal</a></li>
                </ul>
                <button class="theme-toggle" onclick="themeManager.toggle()">
                    <i class="bi bi-moon-stars-fill"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- System Overview Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">CPU Usage</div>
                    <div class="metric-value" id="cpuUsage">0%</div>
                    <small class="text-muted" id="cpuCores">0 cores</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">Memory Usage</div>
                    <div class="metric-value" id="memoryUsage">0%</div>
                    <small class="text-muted" id="memoryTotal">0 MB</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">Goroutines</div>
                    <div class="metric-value" id="goroutines">0</div>
                    <small class="text-muted">Active routines</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">Connected Agents</div>
                    <div class="metric-value" id="connectedAgents">0</div>
                    <small class="text-muted" id="totalAgents">of 0 total</small>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-cpu"></i> CPU & Memory Usage</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="systemChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Workflow Activity</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="workflowChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Metrics -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-hdd-network"></i> Agent Metrics</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Agent</th>
                                        <th>Status</th>
                                        <th>CPU %</th>
                                        <th>Memory %</th>
                                        <th>Tasks Running</th>
                                        <th>Tasks Completed</th>
                                        <th>Last Heartbeat</th>
                                    </tr>
                                </thead>
                                <tbody id="agentMetricsTable">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border text-primary" role="status"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Events & Hooks Stats -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-lightning"></i> Event Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <h3 class="text-primary" id="eventsPending">0</h3>
                                <small class="text-muted">Pending</small>
                            </div>
                            <div class="col-4">
                                <h3 class="text-success" id="eventsProcessed">0</h3>
                                <small class="text-muted">Processed</small>
                            </div>
                            <div class="col-4">
                                <h3 class="text-danger" id="eventsFailed">0</h3>
                                <small class="text-muted">Failed</small>
                            </div>
                        </div>
                        <hr>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="eventsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-hook"></i> Hook Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <h3 class="text-info" id="hooksActive">0</h3>
                                <small class="text-muted">Active</small>
                            </div>
                            <div class="col-4">
                                <h3 class="text-success" id="hooksExecuted">0</h3>
                                <small class="text-muted">Executed</small>
                            </div>
                            <div class="col-4">
                                <h3 class="text-danger" id="hooksFailed">0</h3>
                                <small class="text-muted">Failed</small>
                            </div>
                        </div>
                        <hr>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="hooksChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historical Data -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Historical Metrics</h5>
                        <select class="form-select w-auto" id="historyRange" onchange="loadHistoricalData()">
                            <option value="1h">Last Hour</option>
                            <option value="6h">Last 6 Hours</option>
                            <option value="24h" selected>Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="historicalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/websocket.js"></script>
    <script>
        let systemChart, workflowChart, eventsChart, hooksChart, historicalChart;
        let ws = null;

        // Chart data storage
        const systemData = {
            labels: [],
            cpu: [],
            memory: []
        };

        const workflowData = {
            labels: [],
            active: [],
            total: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadCurrentMetrics();
            loadHistoricalData();
            setupWebSocket();
        });

        function initCharts() {
            const isDark = themeManager.isDark();
            const textColor = isDark ? '#e9ecef' : '#212529';
            const gridColor = isDark ? '#495057' : '#dee2e6';

            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;

            // System Chart (CPU & Memory)
            systemChart = new Chart(document.getElementById('systemChart'), {
                type: 'line',
                data: {
                    labels: systemData.labels,
                    datasets: [{
                        label: 'CPU %',
                        data: systemData.cpu,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Memory %',
                        data: systemData.memory,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });

            // Workflow Chart
            workflowChart = new Chart(document.getElementById('workflowChart'), {
                type: 'bar',
                data: {
                    labels: workflowData.labels,
                    datasets: [{
                        label: 'Active',
                        data: workflowData.active,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)'
                    }, {
                        label: 'Total',
                        data: workflowData.total,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Events Chart
            eventsChart = new Chart(document.getElementById('eventsChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Processed', 'Failed'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Hooks Chart
            hooksChart = new Chart(document.getElementById('hooksChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Executed', 'Failed'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Historical Chart
            historicalChart = new Chart(document.getElementById('historicalChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        async function loadCurrentMetrics() {
            try {
                const data = await API.get('/metrics');
                updateMetrics(data);
            } catch (error) {
                notify.error('Failed to load metrics');
            }
        }

        async function loadHistoricalData() {
            const range = document.getElementById('historyRange').value;

            try {
                const data = await API.get(`/metrics/history?range=${range}`);

                if (data.metrics && data.metrics.length > 0) {
                    historicalChart.data.labels = data.metrics.map(m =>
                        new Date(m.timestamp * 1000).toLocaleTimeString()
                    );
                    historicalChart.data.datasets = [
                        {
                            label: 'CPU %',
                            data: data.metrics.map(m => m.cpu.usage_percent),
                            borderColor: 'rgb(54, 162, 235)',
                            tension: 0.4
                        },
                        {
                            label: 'Memory %',
                            data: data.metrics.map(m => m.memory.used_percent),
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.4
                        },
                        {
                            label: 'Goroutines',
                            data: data.metrics.map(m => m.goroutines),
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ];
                    historicalChart.options.scales = {
                        y: { beginAtZero: true, max: 100, position: 'left' },
                        y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } }
                    };
                    historicalChart.update();
                }
            } catch (error) {
                console.error('Failed to load historical data:', error);
            }
        }

        function setupWebSocket() {
            ws = new WebSocketManager();
            ws.onMessage((data) => {
                if (data.type === 'metrics') {
                    updateMetrics(data);
                }
            });
        }

        function updateMetrics(data) {
            // Update overview cards
            document.getElementById('cpuUsage').textContent = `${data.cpu.usage_percent.toFixed(1)}%`;
            document.getElementById('cpuCores').textContent = `${data.cpu.cores} cores`;

            document.getElementById('memoryUsage').textContent = `${data.memory.used_percent.toFixed(1)}%`;
            document.getElementById('memoryTotal').textContent =
                `${formatBytes(data.memory.used)} / ${formatBytes(data.memory.total)}`;

            document.getElementById('goroutines').textContent = data.goroutines;

            const connectedCount = data.agent_metrics.filter(a => a.status === 'connected').length;
            document.getElementById('connectedAgents').textContent = connectedCount;
            document.getElementById('totalAgents').textContent = `of ${data.agent_metrics.length} total`;

            // Update system chart
            const now = new Date().toLocaleTimeString();
            systemData.labels.push(now);
            systemData.cpu.push(data.cpu.usage_percent);
            systemData.memory.push(data.memory.used_percent);

            if (systemData.labels.length > 20) {
                systemData.labels.shift();
                systemData.cpu.shift();
                systemData.memory.shift();
            }

            systemChart.update();

            // Update workflow chart
            if (data.workflow_metrics) {
                workflowData.labels = ['Workflows'];
                workflowData.active = [data.workflow_metrics.active_count];
                workflowData.total = [data.workflow_metrics.total_count];
                workflowChart.update();
            }

            // Update event stats
            if (data.event_metrics) {
                document.getElementById('eventsPending').textContent = data.event_metrics.pending_count;
                document.getElementById('eventsProcessed').textContent = data.event_metrics.processed_count;
                document.getElementById('eventsFailed').textContent = data.event_metrics.failed_count;

                eventsChart.data.datasets[0].data = [
                    data.event_metrics.pending_count,
                    data.event_metrics.processed_count,
                    data.event_metrics.failed_count
                ];
                eventsChart.update();
            }

            // Update hook stats
            if (data.hook_metrics) {
                document.getElementById('hooksActive').textContent = data.hook_metrics.active_count;
                document.getElementById('hooksExecuted').textContent = data.hook_metrics.executed_count;
                document.getElementById('hooksFailed').textContent = data.hook_metrics.failed_count;

                hooksChart.data.datasets[0].data = [
                    data.hook_metrics.active_count,
                    data.hook_metrics.executed_count,
                    data.hook_metrics.failed_count
                ];
                hooksChart.update();
            }

            // Update agent metrics table
            updateAgentMetricsTable(data.agent_metrics);
        }

        function updateAgentMetricsTable(agents) {
            const tbody = document.getElementById('agentMetricsTable');

            if (!agents || agents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No agents</td></tr>';
                return;
            }

            tbody.innerHTML = agents.map(agent => {
                const statusClass = agent.status === 'connected' ? 'success' : 'secondary';
                return `
                    <tr>
                        <td><strong>${agent.name}</strong></td>
                        <td><span class="badge bg-${statusClass}">${agent.status}</span></td>
                        <td>${agent.cpu_percent.toFixed(1)}%</td>
                        <td>${agent.memory_percent.toFixed(1)}%</td>
                        <td>${agent.tasks_running}</td>
                        <td>${agent.tasks_completed}</td>
                        <td>${timeAgo(agent.last_heartbeat)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Refresh every 5 seconds
        setInterval(loadCurrentMetrics, 5000);
    </script>
</body>
</html>
