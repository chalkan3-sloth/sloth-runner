-- Exemplo prÃ¡tico de uso do Salt como Objeto
-- Demonstrando como usar o salt de forma orientada a objetos

print("ğŸ§‚ SALT COMO OBJETO - EXEMPLO PRÃTICO")
print("=" .. string.rep("=", 60))

-- EXISTEM DUAS FORMAS DE USAR O SALT:

print("\nğŸ“‹ OPÃ‡ÃƒO 1: Salt Tradicional (Funcional)")
print("local salt = require('salt')")
print("local result = salt.ping('*')")

print("\nğŸ“‹ OPÃ‡ÃƒO 2: Salt Orientado a Objetos (Recomendado)")
print("local Salt = require('salt_object_oriented')")
print("local client = Salt({config})")
print("local result = client:ping('*')")

-- 1. CRIAÃ‡ÃƒO DO OBJETO SALT (FORMA ORIENTADA A OBJETOS)
print("\nğŸ”§ Criando cliente Salt orientado a objetos...")

-- Forma CORRETA de usar o salt como objeto
local Salt = require("salt_object_oriented")

-- Criar uma instÃ¢ncia do cliente Salt com configuraÃ§Ãµes especÃ­ficas
local salt_client = Salt({
    master_host = "localhost",
    master_port = 4506,
    timeout = 30,
    retries = 3,
    output_format = "json",
    cache_dir = "/tmp/salt_cache",
    log_level = "info",
    batch_size = 10
})

print("âœ… Cliente Salt OBJETO criado com configuraÃ§Ãµes personalizadas")
print("   Tipo:", type(salt_client))

-- Para comparaÃ§Ã£o, vamos tambÃ©m usar o salt tradicional
local salt_traditional = require("salt")
print("âœ… MÃ³dulo Salt tradicional carregado")
print("   Tipo:", type(salt_traditional))

-- 2. USANDO MÃ‰TODOS DO OBJETO vs TRADICIONAL
print("\nğŸ”Œ Comparando uso de objeto vs tradicional...")

-- FORMA ORIENTADA A OBJETOS (RECOMENDADA)
print("\nğŸ¯ USANDO SALT COMO OBJETO:")
local ping_result_obj = salt_client:ping("*", {timeout = 30})
if ping_result_obj.success then
    print("âœ… Ping OBJETO bem-sucedido")
    if ping_result_obj.returns then
        for minion, response in pairs(ping_result_obj.returns) do
            print("   Minion " .. minion .. ": " .. tostring(response))
        end
    end
else
    print("âŒ Falha no ping OBJETO:", ping_result_obj.error or "Erro desconhecido")
end

-- FORMA TRADICIONAL (PARA COMPARAÃ‡ÃƒO)
print("\nğŸ“‹ USANDO SALT TRADICIONAL:")
local ping_result_trad = salt_traditional.ping("*", {timeout = 30})
if ping_result_trad.success then
    print("âœ… Ping TRADICIONAL bem-sucedido")
else
    print("âŒ Falha no ping TRADICIONAL:", ping_result_trad.error or "Erro desconhecido")
end

print("\nğŸ” DIFERENÃ‡AS IMPORTANTES:")
print("   OBJETO:      salt_client:ping('*')     â† Usa ':' (mÃ©todo do objeto)")
print("   TRADICIONAL: salt.ping('*')            â† Usa '.' (funÃ§Ã£o do mÃ³dulo)")
print("   OBJETO:      ConfiguraÃ§Ã£o encapsulada no cliente")
print("   TRADICIONAL: ConfiguraÃ§Ã£o global do mÃ³dulo")

-- 3. GERENCIAMENTO DE ESTADOS COM OBJETO
print("\nğŸ—ï¸ Gerenciamento de Estados com Objeto...")

-- Aplicar estado usando o objeto (sintaxe correta com ':')
local state_result = salt_client:state_apply("web*", "nginx", {
    test = true,
    pillar = {
        nginx = {
            worker_processes = 4,
            worker_connections = 1024,
            keepalive_timeout = 65
        }
    }
})

if state_result.success then
    print("âœ… Estado aplicado com OBJETO com sucesso")
    print("   DuraÃ§Ã£o:", state_result.duration_ms .. "ms")
else
    print("âŒ Falha na aplicaÃ§Ã£o do estado OBJETO:", state_result.error or "Erro desconhecido")
end

-- Highstate usando o objeto
local highstate_result = salt_client:state_highstate("*", {test = true})
if highstate_result.success then
    print("âœ… Highstate OBJETO executado")
end

-- Mostrar SLS usando objeto
local sls_result = salt_client:state_show_sls("*", "nginx")
if sls_result.success then
    print("âœ… SLS mostrado via OBJETO")
end

-- 4. GERENCIAMENTO DE PACOTES COM OBJETO
print("\nğŸ“¦ Gerenciamento de Pacotes...")

-- Instalar pacote usando o objeto
local pkg_result = salt_client:pkg_install("web*", "nginx")
if pkg_result.success then
    print("âœ… Nginx instalado com sucesso")
end

-- Listar pacotes instalados
local pkg_list = salt_client:pkg_list("*")
if pkg_list.success then
    print("ğŸ“‹ Lista de pacotes obtida")
end

-- Atualizar repositÃ³rios
local pkg_refresh = salt_client:pkg_refresh("*")
if pkg_refresh.success then
    print("ğŸ”„ RepositÃ³rios atualizados")
end

-- 5. GERENCIAMENTO DE SERVIÃ‡OS COM OBJETO
print("\nâš™ï¸ Gerenciamento de ServiÃ§os...")

-- Controlar serviÃ§os usando o objeto
local service_start = salt_client:service_start("web*", "nginx")
if service_start.success then
    print("âœ… Nginx iniciado")
end

-- Verificar status do serviÃ§o
local service_status = salt_client:service_status("*", "nginx")
if service_status.success then
    print("ğŸ“Š Status do nginx verificado")
end

-- Habilitar serviÃ§o
local service_enable = salt_client:service_enable("*", "nginx")
if service_enable.success then
    print("ğŸ”› Nginx habilitado para inicializaÃ§Ã£o automÃ¡tica")
end

-- 6. OPERAÃ‡Ã•ES COM GRAINS USANDO OBJETO
print("\nğŸŒ¾ OperaÃ§Ãµes com Grains...")

-- Obter informaÃ§Ãµes do sistema
local os_info = salt_client:grains_get("*", "os_family")
if os_info.success then
    print("ğŸ–¥ï¸ InformaÃ§Ãµes do sistema operacional:")
    if os_info.returns then
        for minion, os_family in pairs(os_info.returns) do
            print("   " .. minion .. ": " .. tostring(os_family))
        end
    end
end

-- Definir grain customizado
local set_grain = salt_client:grains_set("*", "environment", "production")
if set_grain.success then
    print("âœï¸ Grain 'environment' definido como 'production'")
end

-- Adicionar a lista de grains
local append_grain = salt_client:grains_append("*", "roles", "webserver")
if append_grain.success then
    print("â• 'webserver' adicionado aos roles")
end

-- 7. OPERAÃ‡Ã•ES COM ARQUIVOS USANDO OBJETO
print("\nğŸ“ OperaÃ§Ãµes com Arquivos...")

-- Verificar estatÃ­sticas de arquivo
local file_stats = salt_client:file_stats("*", "/etc/hosts")
if file_stats.success then
    print("ğŸ“Š EstatÃ­sticas do /etc/hosts obtidas")
end

-- Encontrar arquivos
local file_find = salt_client:file_find("*", "/var/log", "name=*.log")
if file_find.success then
    print("ğŸ” Arquivos de log encontrados")
end

-- Copiar arquivo
local file_copy = salt_client:file_copy("*", "/tmp/source.txt", "/tmp/dest.txt")
if file_copy.success then
    print("ğŸ“‹ Arquivo copiado com sucesso")
end

-- 8. OPERAÃ‡Ã•ES AVANÃ‡ADAS COM OBJETO
print("\nğŸš€ OperaÃ§Ãµes AvanÃ§adas...")

-- ExecuÃ§Ã£o em lotes
local batch_result = salt_client:batch("*", "25%", "cmd", "run", "uptime")
if batch_result.success then
    print("ğŸ”„ ExecuÃ§Ã£o em lotes completada (25% por vez)")
end

-- ExecuÃ§Ã£o assÃ­ncrona
local async_result = salt_client:async("*", "cmd", "run", "long-running-command")
if async_result.success then
    print("ğŸš€ Comando assÃ­ncrono iniciado")
    if async_result.jid then
        print("   Job ID:", async_result.jid)
        
        -- Verificar status do job
        local job_status = salt_client:job_lookup(async_result.jid)
        if job_status.success then
            print("ğŸ’¼ Status do job obtido")
        end
    end
end

-- 9. GERENCIAMENTO DE CHAVES COM OBJETO
print("\nğŸ”‘ Gerenciamento de Chaves...")

-- Listar chaves
local keys = salt_client:key_list("all")
if keys.success then
    print("ğŸ—ï¸ Lista de chaves obtida")
end

-- Obter fingerprint
local fingerprint = salt_client:key_finger("*")
if fingerprint.success then
    print("ğŸ‘† Fingerprints das chaves obtidos")
end

-- 10. MONITORAMENTO E MÃ‰TRICAS COM OBJETO
print("\nğŸ“Š Monitoramento e MÃ©tricas...")

-- Obter mÃ©tricas do sistema
local load_avg = salt_client:status_loadavg("*")
if load_avg.success then
    print("ğŸ“ˆ Load average obtido")
end

local mem_info = salt_client:status_meminfo("*")
if mem_info.success then
    print("ğŸ§  InformaÃ§Ãµes de memÃ³ria obtidas")
end

local disk_usage = salt_client:disk_usage("*", "/")
if disk_usage.success then
    print("ğŸ’¾ Uso do disco raiz obtido")
end

-- 11. CONFIGURAÃ‡ÃƒO DE BEACONS COM OBJETO
print("\nğŸš¨ ConfiguraÃ§Ã£o de Beacons...")

-- Adicionar beacon de monitoramento
local beacon_add = salt_client:beacon_add("*", "diskusage", {
    interval = 300,
    threshold = 85
})
if beacon_add.success then
    print("ğŸš¨ Beacon de uso de disco configurado")
end

-- Listar beacons
local beacon_list = salt_client:beacon_list("*")
if beacon_list.success then
    print("ğŸ“‹ Lista de beacons obtida")
end

-- 12. AGENDAMENTO DE TAREFAS COM OBJETO
print("\nâ° Agendamento de Tarefas...")

-- Agendar tarefa
local schedule_add = salt_client:schedule_add("*", "system-backup", {
    function = "cmd.run",
    args = ["/usr/local/bin/backup.sh"],
    hours = 2,
    minutes = 0
})
if schedule_add.success then
    print("â° Backup automÃ¡tico agendado para 02:00")
end

-- Listar tarefas agendadas
local schedule_list = salt_client:schedule_list("*")
if schedule_list.success then
    print("ğŸ“… Lista de tarefas agendadas obtida")
end

-- 13. INTEGRAÃ‡ÃƒO COM CLOUD USANDO OBJETO
print("\nâ˜ï¸ IntegraÃ§Ã£o com Cloud...")

-- Listar nÃ³s na nuvem
local cloud_nodes = salt_client:cloud_list_nodes()
if cloud_nodes.success then
    print("â˜ï¸ NÃ³s na nuvem listados")
end

-- Simular criaÃ§Ã£o de instÃ¢ncia (comentado para evitar execuÃ§Ã£o real)
-- local cloud_create = salt_client:cloud_create("web-profile", "web-server-01")
print("ğŸŒ©ï¸ Funcionalidade de criaÃ§Ã£o de instÃ¢ncias disponÃ­vel")

-- 14. OPERAÃ‡Ã•ES DE REDE COM OBJETO
print("\nğŸŒ OperaÃ§Ãµes de Rede...")

-- InformaÃ§Ãµes de interfaces de rede
local net_interfaces = salt_client:network_interfaces("*")
if net_interfaces.success then
    print("ğŸ”Œ InformaÃ§Ãµes de interfaces de rede obtidas")
end

-- Teste de conectividade de rede
local net_ping = salt_client:network_ping("*", "8.8.8.8")
if net_ping.success then
    print("ğŸ“ Teste de conectividade de rede realizado")
end

-- 15. EXEMPLO DE CONFIGURAÃ‡ÃƒO COMPLEXA COM OBJETO
print("\nğŸ¯ ConfiguraÃ§Ã£o Complexa Usando Objeto...")

-- Criar um segundo cliente com configuraÃ§Ãµes diferentes
local salt_dev = Salt({
    master_host = "dev-salt-master.company.com",
    master_port = 4506,
    timeout = 60,
    retries = 5,
    output_format = "yaml",
    log_level = "debug"
})

print("ğŸ”§ Cliente Salt para desenvolvimento criado")

-- Usar diferentes clientes para diferentes ambientes
local prod_result = salt_client:ping("prod-*")
local dev_result = salt_dev:ping("dev-*")

print("ğŸ­ Teste em produÃ§Ã£o:", prod_result.success and "âœ…" or "âŒ")
print("ğŸ› ï¸ Teste em desenvolvimento:", dev_result.success and "âœ…" or "âŒ")

-- RESUMO FINAL
print("\n" .. string.rep("=", 60))
print("ğŸ‰ DEMONSTRAÃ‡ÃƒO DO SALT COMO OBJETO CONCLUÃDA!")
print("=" .. string.rep("=", 60))

print("\nğŸ“‹ DUAS FORMAS DE USAR O SALT:")
print("1ï¸âƒ£ TRADICIONAL:")
print("   local salt = require('salt')")
print("   local result = salt.ping('*')  â† FunÃ§Ã£o do mÃ³dulo")

print("\n2ï¸âƒ£ ORIENTADO A OBJETOS (RECOMENDADO):")
print("   local Salt = require('salt_object_oriented')")
print("   local client = Salt({config})")
print("   local result = client:ping('*')  â† MÃ©todo do objeto")

print("\nğŸ”§ VANTAGENS DA ABORDAGEM ORIENTADA A OBJETOS:")
print("âœ… ConfiguraÃ§Ã£o isolada por cliente")
print("âœ… MÃºltiplas instÃ¢ncias com configuraÃ§Ãµes diferentes")
print("âœ… Encapsulamento de estado e configuraÃ§Ã£o")
print("âœ… Melhor organizaÃ§Ã£o de cÃ³digo")
print("âœ… Sintaxe mais limpa e intuitiva")
print("âœ… ReutilizaÃ§Ã£o eficiente de recursos")

print("\nğŸ¯ SINTAXE CORRETA:")
print("OBJETO:      client:mÃ©todo()    â† Usa ':' para mÃ©todos")
print("TRADICIONAL: mÃ³dulo.funÃ§Ã£o()    â† Usa '.' para funÃ§Ãµes")

print("\nğŸš€ RECOMENDAÃ‡ÃƒO:")
print("Use 'salt_object_oriented' para novos projetos")
print("Use a sintaxe client:mÃ©todo() para acessar funcionalidades")

print("\nâœ¨ MÃ³dulo Salt orientado a objetos funcionando perfeitamente!")