-- ========================================
-- SALT COMO OBJETO - GUIA PRÃTICO
-- ========================================

print("ğŸ§‚ SALT ORIENTADO A OBJETOS - GUIA DEFINITIVO")
print("=" .. string.rep("=", 50))

-- ===================================
-- 1. IMPORTAÃ‡ÃƒO E CRIAÃ‡ÃƒO DO OBJETO
-- ===================================

print("\nğŸ”§ 1. Criando cliente Salt como objeto...")

-- IMPORTANTE: Use 'salt_object_oriented' para trabalhar com objetos
local Salt = require("salt_object_oriented")

-- Criar instÃ¢ncia do cliente Salt com configuraÃ§Ãµes
local salt_client = Salt({
    master_host = "localhost",
    master_port = 4506,
    timeout = 30,
    retries = 3,
    output_format = "json"
})

print("âœ… Cliente Salt OBJETO criado")
print("   Tipo:", type(salt_client))

-- ===================================
-- 2. USANDO MÃ‰TODOS DO OBJETO
-- ===================================

print("\nğŸ”Œ 2. Usando mÃ©todos do objeto...")

-- SINTAXE CORRETA: objeto:mÃ©todo() com dois pontos ":"
local ping_result = salt_client:ping("*")
if ping_result.success then
    print("âœ… Ping via OBJETO executado com sucesso")
else
    print("âŒ Ping falhou:", ping_result.error or "SimulaÃ§Ã£o")
end

-- Outros exemplos de uso com sintaxe de objeto
local version_result = salt_client:version("*")
print("ğŸ“‹ VersÃ£o obtida via objeto:", version_result.success and "âœ…" or "âŒ")

local grains_result = salt_client:grains_get("*", "os_family")
print("ğŸŒ¾ Grains obtidos via objeto:", grains_result.success and "âœ…" or "âŒ")

-- ===================================
-- 3. OPERAÃ‡Ã•ES AVANÃ‡ADAS COM OBJETO
-- ===================================

print("\nğŸš€ 3. OperaÃ§Ãµes avanÃ§adas...")

-- Estados
local state_result = salt_client:state_apply("web*", "nginx", {test = true})
print("ğŸ—ï¸ Estado aplicado via objeto:", state_result.success and "âœ…" or "âŒ")

-- Pacotes
local pkg_result = salt_client:pkg_install("web*", "nginx")
print("ğŸ“¦ Pacote instalado via objeto:", pkg_result.success and "âœ…" or "âŒ")

-- ServiÃ§os
local service_result = salt_client:service_status("*", "nginx")
print("âš™ï¸ Status do serviÃ§o via objeto:", service_result.success and "âœ…" or "âŒ")

-- ===================================
-- 4. MÃšLTIPLOS CLIENTES (AMBIENTES)
-- ===================================

print("\nğŸ¢ 4. MÃºltiplos clientes para diferentes ambientes...")

-- Cliente para produÃ§Ã£o
local salt_prod = Salt({
    master_host = "prod-salt-master.company.com",
    timeout = 60,
    log_level = "warning"
})

-- Cliente para desenvolvimento
local salt_dev = Salt({
    master_host = "dev-salt-master.company.com", 
    timeout = 30,
    log_level = "debug"
})

print("âœ… Cliente PRODUÃ‡ÃƒO criado")
print("âœ… Cliente DESENVOLVIMENTO criado")

-- Usar diferentes clientes
local prod_ping = salt_prod:ping("prod-*")
local dev_ping = salt_dev:ping("dev-*")

print("ğŸ­ ProduÃ§Ã£o:", prod_ping.success and "âœ… Online" or "âŒ Offline")
print("ğŸ› ï¸ Desenvolvimento:", dev_ping.success and "âœ… Online" or "âŒ Offline")

-- ===================================
-- 5. EXEMPLOS PRÃTICOS COMPLETOS
-- ===================================

print("\nğŸ¯ 5. Exemplos prÃ¡ticos completos...")

-- Exemplo 1: Deploy de aplicaÃ§Ã£o via objeto
local deploy_example = function(client, environment)
    print("ğŸš€ Deploy no ambiente:", environment)
    
    -- Aplicar configuraÃ§Ã£o bÃ¡sica
    local base_config = client:state_apply("*", "base")
    print("   Base config:", base_config.success and "âœ…" or "âŒ")
    
    -- Instalar dependÃªncias
    local deps = client:pkg_install("*", {"nginx", "python3", "git"})
    print("   DependÃªncias:", deps.success and "âœ…" or "âŒ")
    
    -- Aplicar estado da aplicaÃ§Ã£o
    local app_state = client:state_apply("*", "application", {
        pillar = {
            environment = environment,
            version = "v1.2.3"
        }
    })
    print("   App state:", app_state.success and "âœ…" or "âŒ")
    
    -- Verificar serviÃ§os
    local nginx_status = client:service_status("*", "nginx")
    print("   Nginx status:", nginx_status.success and "âœ…" or "âŒ")
    
    return base_config.success and deps.success and app_state.success
end

-- Executar deploy em produÃ§Ã£o
local prod_deploy = deploy_example(salt_prod, "production")
print("ğŸ­ Deploy produÃ§Ã£o:", prod_deploy and "âœ… Sucesso" or "âŒ Falha")

-- Executar deploy em desenvolvimento  
local dev_deploy = deploy_example(salt_dev, "development")
print("ğŸ› ï¸ Deploy desenvolvimento:", dev_deploy and "âœ… Sucesso" or "âŒ Falha")

-- ===================================
-- 6. FUNCIONALIDADES AVANÃ‡ADAS
-- ===================================

print("\nâš¡ 6. Funcionalidades avanÃ§adas do objeto...")

-- OperaÃ§Ãµes assÃ­ncronas
local async_job = salt_client:async("*", "cmd", "run", "long-task")
if async_job.jid then
    print("ğŸ”„ Job assÃ­ncrono iniciado:", async_job.jid)
    
    -- Verificar status do job
    local job_status = salt_client:job_lookup(async_job.jid)
    print("ğŸ’¼ Status do job:", job_status.success and "âœ…" or "âŒ")
end

-- OperaÃ§Ãµes em lote
local batch_result = salt_client:batch("*", "25%", "test", "ping")
print("ğŸ“Š ExecuÃ§Ã£o em lote:", batch_result.success and "âœ…" or "âŒ")

-- ConfiguraÃ§Ã£o de monitoramento
local beacon_config = salt_client:beacon_add("*", "diskusage", {
    interval = 300,
    threshold = 85
})
print("ğŸš¨ Beacon configurado:", beacon_config.success and "âœ…" or "âŒ")

-- Agendamento de tarefas
local schedule_backup = salt_client:schedule_add("*", "daily-backup", {
    function = "cmd.run",
    args = ["/usr/local/bin/backup.sh"],
    hours = 2
})
print("â° Backup agendado:", schedule_backup.success and "âœ…" or "âŒ")

-- ===================================
-- RESUMO E BOAS PRÃTICAS
-- ===================================

print("\n" .. string.rep("=", 50))
print("ğŸ“š RESUMO - SALT COMO OBJETO")
print("=" .. string.rep("=", 50))

print("\nâœ… SINTAXE CORRETA:")
print("   local Salt = require('salt_object_oriented')")
print("   local client = Salt({configuraÃ§Ãµes})")
print("   local result = client:mÃ©todo(parÃ¢metros)")

print("\nğŸ¯ VANTAGENS:")
print("   â€¢ ConfiguraÃ§Ã£o isolada por cliente")
print("   â€¢ MÃºltiplos ambientes simultaneamente")
print("   â€¢ Sintaxe mais limpa e intuitiva")
print("   â€¢ Encapsulamento de estado")
print("   â€¢ ReutilizaÃ§Ã£o eficiente")

print("\nğŸ“‹ MÃ‰TODOS PRINCIPAIS:")
print("   â€¢ client:ping(target)")
print("   â€¢ client:state_apply(target, state)")
print("   â€¢ client:pkg_install(target, package)")
print("   â€¢ client:service_start(target, service)")
print("   â€¢ client:grains_get(target, grain)")

print("\nğŸ”§ CONFIGURAÃ‡Ã•ES IMPORTANTES:")
print("   â€¢ master_host: EndereÃ§o do master Salt")
print("   â€¢ timeout: Timeout das operaÃ§Ãµes")
print("   â€¢ retries: NÃºmero de tentativas")
print("   â€¢ output_format: Formato de saÃ­da (json)")

print("\nğŸš€ EXEMPLO RÃPIDO:")
print("local Salt = require('salt_object_oriented')")
print("local client = Salt({master_host = 'salt-master'})")
print("local result = client:ping('*')")
print("if result.success then")
print("    print('Salt funcionando!')")
print("end")

print("\nâœ¨ Salt orientado a objetos configurado e funcionando!")