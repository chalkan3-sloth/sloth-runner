# üèóÔ∏è Gerenciamento de Estado de Stack

## Vis√£o Geral

O Gerenciamento de Estado de Stack √© um sistema **inspirado no Terraform/Pulumi** que traz as melhores pr√°ticas de infraestrutura como c√≥digo para orquestra√ß√£o de tarefas. Fornece bloqueio de estado, versionamento, detec√ß√£o de drift e rastreamento de depend√™ncias para seus workflows.

### Recursos Principais

- **üîí Bloqueio de Estado**: Previne execu√ß√µes concorrentes que podem conflitar
- **üì∏ Snapshots & Versionamento**: Rastreie mudan√ßas ao longo do tempo com capacidade de rollback
- **üîç Detec√ß√£o de Drift**: Compare o estado desejado vs estado real
- **üîó Rastreamento de Depend√™ncias**: Visualize e gerencie depend√™ncias de stacks
- **‚úÖ Valida√ß√£o**: Verifica√ß√µes pr√©-execu√ß√£o
- **üìä Sistema de Eventos**: Auditoria completa de todas as opera√ß√µes

---

## Arquitetura do Sistema

```mermaid
graph TB
    subgraph CamadaCliente["Camada Cliente"]
        CLI[Cliente CLI]
        API[API REST]
        SDK[SDK/Biblioteca]
    end

    subgraph SistemaEstadoStack["Sistema de Estado de Stack"]
        subgraph ServicosBasicos["Servi√ßos B√°sicos"]
            LockSvc[Servi√ßo de Bloqueio]
            SnapshotSvc[Servi√ßo de Snapshot]
            DriftSvc[Detec√ß√£o de Drift]
        end

        subgraph ServicosAvancados["Servi√ßos Avan√ßados"]
            DepSvc[Rastreador de Depend√™ncias]
            ValidSvc[Servi√ßo de Valida√ß√£o]
            EventSvc[Processador de Eventos]
        end
    end

    subgraph Armazenamento["Camada de Armazenamento"]
        DB[(Banco SQLite)]
        EventStore[(Armazenamento de Eventos)]
    end

    CLI --> LockSvc
    CLI --> SnapshotSvc
    CLI --> DriftSvc
    API --> LockSvc
    SDK --> DepSvc

    LockSvc --> DB
    SnapshotSvc --> DB
    DriftSvc --> DB
    DepSvc --> DB
    ValidSvc --> DB

    LockSvc --> EventSvc
    SnapshotSvc --> EventSvc
    DriftSvc --> EventSvc

    EventSvc --> EventStore
```

### Vis√£o Geral dos Componentes

| Componente | Prop√≥sito | Recursos Principais |
|-----------|---------|--------------|
| **Servi√ßo de Bloqueio** | Prevenir acesso concorrente | Rastreamento de metadados, libera√ß√£o for√ßada, verifica√ß√£o de status |
| **Servi√ßo de Snapshot** | Gerenciamento de vers√£o | Versionamento autom√°tico, rollback, compara√ß√£o |
| **Detec√ß√£o de Drift** | Valida√ß√£o de estado | Comparar real vs desejado, corre√ß√£o autom√°tica |
| **Rastreador de Depend√™ncias** | Gerenciar relacionamentos | Detec√ß√£o circular, ordena√ß√£o de execu√ß√£o |
| **Servi√ßo de Valida√ß√£o** | Verifica√ß√µes pr√©-execu√ß√£o | Verifica√ß√£o de recursos, valida√ß√£o de config |
| **Processador de Eventos** | Trilha de auditoria | 100 workers, buffer de 1000 eventos |

---

## Bloqueio de Estado

### Vis√£o Geral

O bloqueio de estado previne que m√∫ltiplas opera√ß√µes modifiquem o mesmo stack simultaneamente, garantindo integridade dos dados e prevenindo condi√ß√µes de corrida.

### Ciclo de Vida do Bloqueio

```mermaid
stateDiagram-v2
    [*] --> Desbloqueado
    Desbloqueado --> Adquirindo: lock acquire
    Adquirindo --> Bloqueado: Sucesso
    Adquirindo --> Desbloqueado: Falha

    Bloqueado --> Liberando: lock release
    Liberando --> Desbloqueado: Sucesso

    Bloqueado --> LiberacaoForcada: force-release
    LiberacaoForcada --> Desbloqueado: Sucesso

    Bloqueado --> Bloqueado: Verifica√ß√£o de Status
    Desbloqueado --> Desbloqueado: Verifica√ß√£o de Status
```

### Comandos

#### Adquirir Bloqueio

```bash
sloth-runner stack lock acquire <nome-stack> [op√ß√µes]
```

**Op√ß√µes**:
- `--reason <texto>` - Por que voc√™ est√° adquirindo o bloqueio
- `--locked-by <identidade>` - Quem est√° bloqueando (padr√£o: usu√°rio atual)
- `--operation <nome>` - Opera√ß√£o sendo executada

**Exemplo**:
```bash
$ sloth-runner stack lock acquire production-stack \
    --reason "Implantando v2.0.0" \
    --locked-by "deploy-bot" \
    --operation "deployment"

‚úì Bloqueio adquirido para stack 'production-stack'

Detalhes do Bloqueio:
  Bloqueado por:    deploy-bot
  Bloqueado em:     2025-10-10 14:41:31
  Opera√ß√£o:         deployment
  Motivo:           Implantando v2.0.0
```

#### Verificar Status do Bloqueio

```bash
sloth-runner stack lock status <nome-stack>
```

**Exemplo de Sa√≠da**:
```bash
$ sloth-runner stack lock status production-stack

Stack: production-stack
Status: BLOQUEADO

Detalhes do Bloqueio:
  Bloqueado por:    deploy-bot
  Bloqueado em:     2025-10-10 14:41:31
  Opera√ß√£o:         deployment
  Motivo:           Implantando v2.0.0
  Dura√ß√£o:          5m 23s
```

#### Liberar Bloqueio

```bash
sloth-runner stack lock release <nome-stack> [op√ß√µes]
```

**Op√ß√µes**:
- `--unlocked-by <identidade>` - Quem est√° liberando o bloqueio

**Exemplo**:
```bash
$ sloth-runner stack lock release production-stack \
    --unlocked-by "deploy-bot"

‚úì Bloqueio liberado para stack 'production-stack'
```

#### Liberar Bloqueio For√ßadamente

‚ö†Ô∏è **Use com cuidado** - Apenas para situa√ß√µes de emerg√™ncia

```bash
sloth-runner stack lock force-release <nome-stack> [op√ß√µes]
```

**Exemplo**:
```bash
$ sloth-runner stack lock force-release production-stack \
    --reason "Manuten√ß√£o de emerg√™ncia"

‚ö† ATEN√á√ÉO: Libera√ß√£o for√ßada de bloqueio para stack 'production-stack'
‚úì Bloqueio liberado for√ßadamente
```

### Casos de Uso

- **Implanta√ß√µes longas**: Prevenir que outras implanta√ß√µes iniciem
- **Opera√ß√µes multi-etapa**: Garantir execu√ß√£o at√¥mica
- **Colabora√ß√£o em equipe**: Coordenar trabalho entre membros da equipe
- **Manuten√ß√£o de emerg√™ncia**: Liberar bloqueios travados

---

## Snapshots & Versionamento

### Vis√£o Geral

Snapshots fornecem backups pontuais do estado do seu stack, permitindo rollback e compara√ß√£o de vers√µes.

### Ciclo de Vida do Snapshot

```mermaid
sequenceDiagram
    participant Usuario
    participant CLI
    participant ServicoSnapshot
    participant BancoDados
    participant ArmazenamentoEventos

    Usuario->>CLI: snapshot create
    CLI->>ServicoSnapshot: CreateSnapshot(stack, metadados)
    ServicoSnapshot->>BancoDados: Consultar estado atual
    BancoDados-->>ServicoSnapshot: Dados de estado
    ServicoSnapshot->>ServicoSnapshot: Gerar vers√£o (v38)
    ServicoSnapshot->>BancoDados: Armazenar snapshot
    ServicoSnapshot->>ArmazenamentoEventos: Emitir evento snapshot.created
    ArmazenamentoEventos-->>ServicoSnapshot: Evento armazenado
    ServicoSnapshot-->>CLI: Snapshot criado
    CLI-->>Usuario: ‚úì Snapshot v38 criado
```

### Comandos

#### Criar Snapshot

```bash
sloth-runner stack snapshot create <nome-stack> [op√ß√µes]
```

**Op√ß√µes**:
- `--description <texto>` - Descri√ß√£o do snapshot
- `--creator <identidade>` - Quem criou o snapshot
- `--tags <tags>` - Tags para categoriza√ß√£o

**Exemplo**:
```bash
$ sloth-runner stack snapshot create production-stack \
    --description "Antes da atualiza√ß√£o v2.0" \
    --creator "admin" \
    --tags "producao,atualizacao"

‚úì Snapshot criado para stack 'production-stack'

Detalhes do Snapshot:
  Vers√£o:       v38
  Criador:      admin
  Descri√ß√£o:    Antes da atualiza√ß√£o v2.0
  Tags:         producao, atualizacao
  Criado:       2025-10-10 14:30:00
```

#### Listar Snapshots

```bash
sloth-runner stack snapshot list <nome-stack>
```

**Exemplo de Sa√≠da**:
```bash
$ sloth-runner stack snapshot list production-stack

Snapshots para stack: production-stack

Vers√£o  Criador        Descri√ß√£o                   Criado em            Tags
------  -------------  --------------------------  -------------------  ----------------
v38     admin          Antes da atualiza√ß√£o v2.0   2025-10-10 14:30:00  producao,atualizacao
v37     system         Snapshot autom√°tico         2025-10-10 14:15:00  auto
v36     admin          Backup pr√©-manuten√ß√£o       2025-10-10 13:00:00  manutencao
v35     deploy-bot     P√≥s-implanta√ß√£o             2025-10-10 12:30:00  deployment

Total: 38 snapshots
```

#### Mostrar Detalhes do Snapshot

```bash
sloth-runner stack snapshot show <nome-stack> <vers√£o>
```

**Exemplo**:
```bash
$ sloth-runner stack snapshot show production-stack v38

Detalhes do Snapshot:
  Stack:        production-stack
  Vers√£o:       v38
  Criador:      admin
  Descri√ß√£o:    Antes da atualiza√ß√£o v2.0
  Criado em:    2025-10-10 14:30:00
  Tamanho:      1.2 MB

Resumo do Estado:
  Recursos:     15 recursos
  Tarefas:      8 tarefas
  Status:       completed
```

#### Restaurar Snapshot

```bash
sloth-runner stack snapshot restore <nome-stack> <vers√£o>
```

**Exemplo**:
```bash
$ sloth-runner stack snapshot restore production-stack v38

‚ö† ATEN√á√ÉO: Isto restaurar√° o stack para o snapshot v38
Tem certeza? (sim/n√£o): sim

‚úì Restaurando snapshot v38...
‚úì Snapshot restaurado com sucesso

Estado Atual:
  Vers√£o:         v38
  Restaurado em:  2025-10-10 15:00:00
  Restaurado por: admin
```

#### Comparar Snapshots

```bash
sloth-runner stack snapshot compare <nome-stack> <v1> <v2>
```

**Exemplo**:
```bash
$ sloth-runner stack snapshot compare production-stack v37 v38

Comparando snapshots: v37 -> v38

Mudan√ßas:
  + Recurso adicionado: database-server
  ~ Recurso modificado: web-server (replicas: 2 -> 4)
  - Recurso removido: cache-server

Mudan√ßas de Tarefas:
  ~ deploy_app: timeout 10m -> 15m
  + Nova tarefa: configure_database
```

#### Deletar Snapshot

```bash
sloth-runner stack snapshot delete <nome-stack> <vers√£o>
```

### Snapshots Autom√°ticos

Habilite snapshots autom√°ticos antes de opera√ß√µes cr√≠ticas:

```yaml
# Config: /etc/sloth-runner/config.yaml
stacks:
  auto_snapshot: true
  snapshot_retention: 30d  # Manter por 30 dias
  snapshot_triggers:
    - before_deployment
    - before_destroy
    - on_drift_fix
```

---

## Detec√ß√£o de Drift

### Vis√£o Geral

A detec√ß√£o de drift identifica diferen√ßas entre o estado desejado (definido no seu workflow) e o estado real (o que est√° implantado).

### Fluxo de Detec√ß√£o de Drift

```mermaid
graph LR
    subgraph Deteccao["Processo de Detec√ß√£o de Drift"]
        Inicio[Iniciar Verifica√ß√£o]
        LerDesejado[Ler Estado Desejado]
        LerReal[Ler Estado Real]
        Comparar[Comparar Estados]
        Analisar[Analisar Diferen√ßas]
        Relatorio[Gerar Relat√≥rio]
    end

    subgraph Resultados["Resultados da Detec√ß√£o"]
        SemDrift[Sem Drift Detectado]
        DriftEncontrado[Drift Detectado]
        GerarCorrecao[Gerar Plano de Corre√ß√£o]
    end

    Inicio --> LerDesejado
    LerDesejado --> LerReal
    LerReal --> Comparar
    Comparar --> Analisar
    Analisar --> Relatorio

    Relatorio --> SemDrift
    Relatorio --> DriftEncontrado
    DriftEncontrado --> GerarCorrecao
```

### Tipos de Drift

```mermaid
graph TB
    subgraph TiposDrift["Tipos de Drift"]
        ConfigDrift[Drift de Configura√ß√£o]
        ResourceDrift[Drift de Recurso]
        StateDrift[Drift de Estado]
        DependencyDrift[Drift de Depend√™ncia]
    end

    ConfigDrift --> |Exemplo| ConfigEx["Porta alterada: 8080 -> 9090"]
    ResourceDrift --> |Exemplo| ResourceEx["Quantidade de servidores: 3 -> 2"]
    StateDrift --> |Exemplo| StateEx["Status: running -> stopped"]
    DependencyDrift --> |Exemplo| DepEx["Depend√™ncia ausente: redis"]
```

### Comandos

#### Detectar Drift

```bash
sloth-runner stack drift detect <nome-stack>
```

**Exemplo de Sa√≠da**:
```bash
$ sloth-runner stack drift detect production-stack

Detectando drift para stack: production-stack

‚úì Detec√ß√£o de drift conclu√≠da

Resumo:
  Recursos com Drift:     3
  Recursos Sincronizados: 12
  Total de Recursos:      15

Recursos com Drift:
  ‚Ä¢ web-server: replicas (esperado: 4, real: 2)
  ‚Ä¢ database: port (esperado: 5432, real: 5433)
  ‚Ä¢ cache: status (esperado: running, real: stopped)

Execute 'drift show' para relat√≥rio detalhado
Execute 'drift fix' para corrigir drift automaticamente
```

#### Mostrar Relat√≥rio de Drift

```bash
sloth-runner stack drift show <nome-stack>
```

**Exemplo de Sa√≠da**:
```bash
$ sloth-runner stack drift show production-stack

Relat√≥rio de Drift para: production-stack
Gerado: 2025-10-10 15:15:00

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Recurso: web-server
Tipo: Drift de Configura√ß√£o
Severidade: ALTA

Atributo: replicas
  Esperado:  4
  Real:      2
  Impacto:   Capacidade reduzida

Corre√ß√£o Sugerida:
  $ kubectl scale deployment web-server --replicas=4

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Recurso: database
Tipo: Drift de Configura√ß√£o
Severidade: M√âDIA

Atributo: port
  Esperado:  5432
  Real:      5433
  Impacto:   Problemas de conectividade

Corre√ß√£o Sugerida:
  Atualizar configura√ß√£o do banco para usar porta 5432

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Recurso: cache
Tipo: Drift de Estado
Severidade: ALTA

Atributo: status
  Esperado:  running
  Real:      stopped
  Impacto:   Degrada√ß√£o do servi√ßo

Corre√ß√£o Sugerida:
  $ systemctl start redis
```

#### Corrigir Drift

```bash
sloth-runner stack drift fix <nome-stack> [op√ß√µes]
```

**Op√ß√µes**:
- `--auto-approve` - Pular confirma√ß√£o
- `--dry-run` - Mostrar o que seria corrigido
- `--resource <nome>` - Corrigir apenas recurso espec√≠fico

**Exemplo**:
```bash
$ sloth-runner stack drift fix production-stack --dry-run

Plano de Corre√ß√£o de Drift para: production-stack

As seguintes a√ß√µes ser√£o executadas:

  ‚Ä¢ web-server: Escalar replicas de 2 para 4
  ‚Ä¢ database: Alterar porta de 5433 para 5432
  ‚Ä¢ cache: Iniciar servi√ßo (status: stopped -> running)

Execute sem --dry-run para aplicar as corre√ß√µes
```

```bash
$ sloth-runner stack drift fix production-stack --auto-approve

Corrigindo drift para stack: production-stack

‚úì web-server: Escalado para 4 r√©plicas
‚úì database: Porta atualizada para 5432
‚úì cache: Servi√ßo iniciado

Resumo:
  Corrigidos:  3 recursos
  Falharam:    0 recursos
  Pulados:     0 recursos

‚úì Todo drift corrigido
```

---

## Gerenciamento de Depend√™ncias

### Vis√£o Geral

O gerenciamento de depend√™ncias garante que os stacks sejam executados na ordem correta e previne depend√™ncias circulares.

### Grafo de Depend√™ncias

```mermaid
graph TB
    subgraph CamadaInfraestrutura["Camada de Infraestrutura"]
        Network[network-stack]
        Storage[storage-stack]
    end

    subgraph CamadaDados["Camada de Dados"]
        Database[database-stack]
        Cache[cache-stack]
    end

    subgraph CamadaAplicacao["Camada de Aplica√ß√£o"]
        Backend[backend-stack]
        Frontend[frontend-stack]
    end

    subgraph CamadaMonitoramento["Camada de Monitoramento"]
        Metrics[metrics-stack]
        Logging[logging-stack]
    end

    Network --> Database
    Network --> Cache
    Storage --> Database

    Database --> Backend
    Cache --> Backend

    Backend --> Frontend
    Backend --> Metrics
    Backend --> Logging
```

### Comandos

#### Mostrar Depend√™ncias

```bash
sloth-runner stack deps show <nome-stack>
```

**Exemplo de Sa√≠da**:
```bash
$ sloth-runner stack deps show backend-stack

Depend√™ncias para: backend-stack

Depend√™ncias Diretas:
  ‚Ä¢ database-stack (v2.1.0)
  ‚Ä¢ cache-stack (v1.5.0)
  ‚Ä¢ network-stack (v3.0.0)

Depend√™ncias Indiretas:
  ‚Ä¢ storage-stack (via database-stack)
  ‚Ä¢ monitoring-stack (via database-stack)

Dependentes (stacks que dependem deste):
  ‚Ä¢ frontend-stack
  ‚Ä¢ metrics-stack
  ‚Ä¢ logging-stack

Total de depend√™ncias: 6
Profundidade de depend√™ncia: 2 n√≠veis
```

#### Gerar Grafo de Depend√™ncias

```bash
sloth-runner stack deps graph <nome-stack> [op√ß√µes]
```

**Op√ß√µes**:
- `--output <arquivo>` - Arquivo de sa√≠da (PNG, SVG ou DOT)
- `--format <formato>` - Formato de sa√≠da (padr√£o: PNG)
- `--show-versions` - Incluir n√∫meros de vers√£o
- `--full-tree` - Mostrar todas depend√™ncias transitivas

**Exemplo**:
```bash
$ sloth-runner stack deps graph backend-stack \
    --output deps.png \
    --show-versions \
    --full-tree

‚úì Grafo de depend√™ncias gerado: deps.png

Estat√≠sticas do Grafo:
  Total de n√≥s:       12
  Total de arestas:   18
  Profundidade m√°x:   4
  Deps circulares:    0
```

#### Verificar Depend√™ncias Circulares

```bash
sloth-runner stack deps check <nome-stack>
```

**Exemplo de Sa√≠da** (Sem depend√™ncias circulares):
```bash
$ sloth-runner stack deps check backend-stack

Verificando depend√™ncias para: backend-stack

‚úì Nenhuma depend√™ncia circular detectada

√Årvore de depend√™ncias √© v√°lida
```

**Exemplo de Sa√≠da** (Depend√™ncia circular detectada):
```bash
$ sloth-runner stack deps check app-stack

Verificando depend√™ncias para: app-stack

‚úó Depend√™ncia circular detectada!

Caminho do ciclo:
  app-stack -> database-stack -> cache-stack -> app-stack

Sugest√µes de resolu√ß√£o:
  1. Remover depend√™ncia: cache-stack -> app-stack
  2. Introduzir stack intermedi√°rio
  3. Refatorar para eliminar refer√™ncia circular
```

#### Determinar Ordem de Execu√ß√£o

```bash
sloth-runner stack deps order <nomes-stacks...>
```

**Exemplo**:
```bash
$ sloth-runner stack deps order \
    frontend-stack backend-stack database-stack cache-stack network-stack

Calculando ordem de execu√ß√£o...

Ordem de execu√ß√£o recomendada:
  1. network-stack (sem depend√™ncias)
  2. storage-stack (depende de: network-stack)
  3. cache-stack (depende de: network-stack)
  4. database-stack (depende de: network-stack, storage-stack)
  5. backend-stack (depende de: database-stack, cache-stack)
  6. frontend-stack (depende de: backend-stack)

Estimativa de tempo total: ~25 minutos
Grupos paraleliz√°veis:
  Grupo 1: network-stack
  Grupo 2: storage-stack, cache-stack
  Grupo 3: database-stack
  Grupo 4: backend-stack
  Grupo 5: frontend-stack

Com paraleliza√ß√£o: ~15 minutos
```

---

## Valida√ß√£o

### Vis√£o Geral

A valida√ß√£o executa verifica√ß√µes pr√©-execu√ß√£o antes de executar workflows, capturando erros antecipadamente.

### Checklist de Valida√ß√£o

```mermaid
graph TB
    Inicio[Iniciar Valida√ß√£o] --> ConfigCheck{Configura√ß√£o V√°lida?}
    ConfigCheck -->|N√£o| ConfigError[Reportar Erros de Config]
    ConfigCheck -->|Sim| DepCheck{Depend√™ncias Satisfeitas?}

    DepCheck -->|N√£o| DepError[Reportar Depend√™ncias Ausentes]
    DepCheck -->|Sim| ResourceCheck{Recursos Dispon√≠veis?}

    ResourceCheck -->|N√£o| ResourceError[Reportar Problemas de Recursos]
    ResourceCheck -->|Sim| PermCheck{Permiss√µes OK?}

    PermCheck -->|N√£o| PermError[Reportar Problemas de Permiss√£o]
    PermCheck -->|Sim| LockCheck{Bloqueio Dispon√≠vel?}

    LockCheck -->|N√£o| LockError[Reportar Conflito de Bloqueio]
    LockCheck -->|Sim| Success[‚úì Valida√ß√£o Passou]

    ConfigError --> Failed[‚úó Valida√ß√£o Falhou]
    DepError --> Failed
    ResourceError --> Failed
    PermError --> Failed
    LockError --> Failed
```

### Comandos

#### Validar Stack √önico

```bash
sloth-runner stack validate <nome-stack>
```

**Exemplo de Sa√≠da** (Sucesso):
```bash
$ sloth-runner stack validate production-stack

Validando stack: production-stack

‚úì Sintaxe de configura√ß√£o v√°lida
‚úì Todas depend√™ncias dispon√≠veis
‚úì Recursos necess√°rios existem
‚úì Permiss√µes suficientes
‚úì Sem conflitos de bloqueio
‚úì Defini√ß√£o de workflow v√°lida
‚úì Todos m√≥dulos dispon√≠veis

Valida√ß√£o passou: production-stack est√° pronto para execu√ß√£o
```

**Exemplo de Sa√≠da** (Falha):
```bash
$ sloth-runner stack validate production-stack

Validando stack: production-stack

‚úì Sintaxe de configura√ß√£o v√°lida
‚úì Depend√™ncias dispon√≠veis
‚úó Verifica√ß√£o de recursos falhou
  - Arquivo ausente: /config/app.yaml
  - Espa√ßo em disco insuficiente: 100MB requerido, 50MB dispon√≠vel
‚úó Verifica√ß√£o de permiss√£o falhou
  - N√£o pode escrever em: /var/log/app/
‚úì Sem conflitos de bloqueio

‚úó Valida√ß√£o falhou: 2 erros encontrados

Corrija estes problemas antes de executar o stack.
```

#### Validar Todos os Stacks

```bash
sloth-runner stack validate all
```

**Exemplo de Sa√≠da**:
```bash
$ sloth-runner stack validate all

Validando todos os stacks...

Stack: production-stack
  Status: ‚úì PASSOU

Stack: staging-stack
  Status: ‚úì PASSOU

Stack: dev-stack
  Status: ‚úó FALHOU
  Erros:
    - Depend√™ncia ausente: database-stack
    - Configura√ß√£o inv√°lida: timeout deve ser > 0

Resumo:
  Total:    3 stacks
  Passaram: 2 stacks
  Falharam: 1 stack

Geral: FALHOU
```

---

## Comandos de Stack

### Opera√ß√µes Principais

#### Listar Stacks

```bash
sloth-runner stack list [op√ß√µes]
```

**Op√ß√µes**:
- `--status <status>` - Filtrar por status (created, running, completed, failed)
- `--format <formato>` - Formato de sa√≠da (table, json, yaml)

**Exemplo de Sa√≠da**:
```bash
$ sloth-runner stack list

Stacks de Workflow

NOME                STATUS      √öLTIMA EXECU√á√ÉO      DURA√á√ÉO    EXECU√á√ïES
----                ------      ---------------      --------   ----------
production-stack    completed   2025-10-10 14:30:15  71ms       10
staging-stack       running     2025-10-10 14:35:00  0s         5
dev-stack           created     2025-10-10 14:20:00  0s         0
database-stack      completed   2025-10-10 13:45:22  125ms      8
cache-stack         failed      2025-10-10 14:00:00  15ms       3

Total: 5 stacks
```

#### Mostrar Detalhes do Stack

```bash
sloth-runner stack show <nome-stack>
```

**Exemplo de Sa√≠da**:
```bash
$ sloth-runner stack show production-stack

Stack: production-stack

Informa√ß√µes Gerais:
  Status:            completed
  Vers√£o:            v2.0.0
  Criado:            2025-10-09 10:00:00
  √öltima Atualiza√ß√£o:2025-10-10 14:30:15
  Total de Execu√ß√µes:10

√öltima Execu√ß√£o:
  Iniciada:          2025-10-10 14:30:00
  Conclu√≠da:         2025-10-10 14:30:15
  Dura√ß√£o:           71ms
  Status:            success

Recursos (15):
  ‚Ä¢ web-server (running)
  ‚Ä¢ database (running)
  ‚Ä¢ cache (running)
  ‚Ä¢ load-balancer (running)
  ... mais 11

Depend√™ncias (3):
  ‚Ä¢ database-stack
  ‚Ä¢ cache-stack
  ‚Ä¢ network-stack

Status do Bloqueio:
  Status:            desbloqueado
  √öltimo Bloqueio:   2025-10-10 14:30:00
  Bloqueado Por:     deploy-bot
  Dura√ß√£o do Bloqueio:15s

Snapshots:
  Total de Snapshots:38
  √öltimo Snapshot:   v38 (2025-10-10 14:30:00)
```

#### Obter Sa√≠das do Stack

```bash
sloth-runner stack output <nome-stack> [chave]
```

**Exemplo de Sa√≠da**:
```bash
$ sloth-runner stack output production-stack

Sa√≠das para: production-stack

deployment_url    = https://app.production.example.com
database_host     = db.production.internal
api_key           = <sens√≠vel>
load_balancer_ip  = 203.0.113.42
version           = v2.0.0
```

**Obter sa√≠da espec√≠fica**:
```bash
$ sloth-runner stack output production-stack deployment_url

https://app.production.example.com
```

---

## Schema do Banco de Dados

### Tabelas

```mermaid
erDiagram
    STACKS ||--o{ STATE_LOCKS : tem
    STACKS ||--o{ STATE_VERSIONS : tem
    STACKS ||--o{ STATE_EVENTS : gera
    STACKS ||--o{ RESOURCES : contem
    RESOURCES }o--o{ RESOURCES : depende_de

    STACKS {
        int id PK
        string name UK
        string description
        string status
        string version
        datetime created_at
        datetime updated_at
        datetime last_execution
        int execution_count
    }

    STATE_LOCKS {
        int stack_id FK
        string locked_by
        datetime locked_at
        string operation
        string reason
        json metadata
    }

    STATE_VERSIONS {
        int id PK
        int stack_id FK
        string version
        string creator
        string description
        blob state_data
        datetime created_at
    }

    STATE_EVENTS {
        int id PK
        int stack_id FK
        string event_type
        string severity
        string message
        string source
        datetime created_at
    }

    RESOURCES {
        int id PK
        int stack_id FK
        string name
        string type
        string state
        json dependencies
    }
```

### Localiza√ß√£o do Banco de Dados

Localiza√ß√£o padr√£o: `/etc/sloth-runner/stacks.db`

**Recursos**:
- Cria√ß√£o autom√°tica no primeiro uso
- Chaves estrangeiras for√ßadas
- √çndices otimizados
- Conformidade ACID
- Backups autom√°ticos

---

## Sistema de Eventos

### Tipos de Eventos

```mermaid
graph TB
    subgraph EventosStack["Eventos de Stack"]
        StackCreated[stack.created]
        StackUpdated[stack.updated]
        StackDestroyed[stack.destroyed]
        ExecStarted[stack.execution.started]
        ExecCompleted[stack.execution.completed]
        ExecFailed[stack.execution.failed]
    end

    subgraph EventosBloqueio["Eventos de Bloqueio"]
        LockAcquired[lock.acquired]
        LockReleased[lock.released]
        LockForced[lock.force_released]
    end

    subgraph EventosSnapshot["Eventos de Snapshot"]
        SnapCreated[snapshot.created]
        SnapRestored[snapshot.restored]
        SnapDeleted[snapshot.deleted]
    end

    subgraph EventosDrift["Eventos de Drift"]
        DriftDetected[drift.detected]
        DriftFixed[drift.fixed]
    end

    EventosStack --> EventProcessor[Processador de Eventos]
    EventosBloqueio --> EventProcessor
    EventosSnapshot --> EventProcessor
    EventosDrift --> EventProcessor

    EventProcessor --> Hooks[Executar Hooks]
    EventProcessor --> Storage[(Armazenamento de Eventos)]
    EventProcessor --> Metrics[Atualizar M√©tricas]
```

### Processamento de Eventos

- **Workers**: 100 workers concorrentes
- **Buffer**: Capacidade de 1000 eventos
- **Persist√™ncia**: Todos eventos armazenados no banco
- **Hooks**: Execu√ß√£o autom√°tica de hooks em eventos

---

## M√©tricas de Performance

### Performance Medida

| Opera√ß√£o | Dura√ß√£o M√©dia | Notas |
|-----------|------------------|-------|
| Execu√ß√£o de Workflow | 71ms | 5 tarefas |
| Adquirir/Liberar Bloqueio | < 50ms | Incluindo persist√™ncia |
| Cria√ß√£o de Snapshot | < 100ms | Stack t√≠pico |
| Comandos de Stack | < 50ms | List, show, etc. |
| Consultas ao Banco | < 10ms | Lookups indexados |
| Detec√ß√£o de Drift | 200-500ms | Depende da quantidade de recursos |
| Valida√ß√£o | 100-300ms | Verifica√ß√µes abrangentes |

### Sa√∫de do Sistema

‚úÖ Sem vazamentos de mem√≥ria
‚úÖ Sem corrup√ß√£o de banco de dados
‚úÖ Sem processos travados
‚úÖ Execu√ß√£o limpa
‚úÖ Limpeza adequada

---

## Integra√ß√£o com Workflows

### Configura√ß√£o DSL

```lua
-- Definir tarefa com gerenciamento autom√°tico de estado
local deploy = task("deploy_app")
    :description("Implantar aplica√ß√£o com gerenciamento de estado")
    :command(function()
        -- Estado √© gerenciado automaticamente
        state.set("deployment_version", "v2.0.0")
        state.set("deployed_at", os.time())
        state.set("deployed_by", os.getenv("USER"))

        -- L√≥gica de implanta√ß√£o
        exec.run("kubectl apply -f deployment.yaml")

        -- Armazenar sa√≠das
        state.set("deployment_url", "https://app.example.com")

        return true, "Implanta√ß√£o bem-sucedida"
    end)
    :build()

-- Definir workflow com configura√ß√£o de stack
workflow.define("production_deploy")
    :description("Implanta√ß√£o em produ√ß√£o com gerenciamento completo de estado")
    :version("2.0.0")
    :tasks({deploy})
    :config({
        timeout = "30m",
        require_lock = true,      -- Bloqueio autom√°tico
        create_snapshot = true,   -- Snapshot autom√°tico antes da execu√ß√£o
        validate_before = true,   -- Valida√ß√£o pr√©-execu√ß√£o
        detect_drift = true,      -- Verifica√ß√£o de drift p√≥s-execu√ß√£o
        on_failure = "rollback"   -- Rollback autom√°tico em falha
    })
```

### API de Estado

```lua
-- Definir valor de estado
state.set(key, value)

-- Obter valor de estado
local value = state.get(key)

-- Deletar valor de estado
state.delete(key)

-- Obter todo o estado
local all_state = state.get_all()

-- Verificar se chave existe
if state.has(key) then
    -- chave existe
end
```

---

## Configura√ß√£o

### Arquivo de Configura√ß√£o

Localiza√ß√£o: `/etc/sloth-runner/config.yaml`

```yaml
stacks:
  # Configura√ß√£o do banco de dados
  database_path: /etc/sloth-runner/stacks.db

  # Recursos autom√°ticos
  auto_lock: true                    # Auto-bloqueio durante execu√ß√£o
  auto_snapshot: true                # Snapshot autom√°tico antes de mudan√ßas
  auto_drift_detect: false           # Auto-detec√ß√£o de drift ap√≥s execu√ß√£o

  # Timeouts e limites
  lock_timeout: 1h                   # Dura√ß√£o m√°xima do bloqueio
  snapshot_retention: 30d            # Quanto tempo manter snapshots
  max_concurrent_executions: 10      # M√°ximo de execu√ß√µes paralelas de stack

  # Gatilhos de snapshot
  snapshot_triggers:
    - before_deployment
    - before_destroy
    - on_drift_fix
    - manual

  # Sistema de eventos
  events:
    workers: 100                     # Workers do processador de eventos
    buffer_size: 1000                # Capacidade do buffer de eventos
    batch_size: 50                   # Eventos por lote

  # Valida√ß√£o
  validation:
    strict_mode: true                # Falhar em warnings
    check_disk_space: true
    min_disk_space: 100MB
    check_permissions: true
```

---

## Melhores Pr√°ticas

### 1. Gerenciamento de Bloqueios

‚úÖ **Sempre libere bloqueios** - Use blocos `defer` ou `finally`
‚úÖ **Use motivos significativos** - Ajude a equipe a entender o porqu√™
‚úÖ **Defina timeouts apropriados** - N√£o bloqueie para sempre
‚úÖ **Monitore dura√ß√£o de bloqueios** - Alerte sobre bloqueios longos

‚ùå **N√£o libere for√ßadamente casualmente** - Apenas para emerg√™ncias
‚ùå **N√£o esque√ßa de verificar status** - Verifique antes de adquirir

### 2. Estrat√©gia de Snapshots

‚úÖ **Snapshot antes de mudan√ßas maiores** - Sempre tenha um ponto de rollback
‚úÖ **Use descri√ß√µes descritivas** - Saiba o que cada snapshot √©
‚úÖ **Marque snapshots com tags** - Categorize para encontrar facilmente
‚úÖ **Limpeza regular** - Remova snapshots antigos (automatizado)

‚ùå **N√£o confie apenas em snapshots autom√°ticos** - Snapshots manuais para mudan√ßas importantes
‚ùå **N√£o pule compara√ß√£o** - Compare antes de restaurar

### 3. Gerenciamento de Drift

‚úÖ **Verifica√ß√µes regulares de drift** - Agende verifica√ß√µes automatizadas
‚úÖ **Corrija drift prontamente** - N√£o deixe acumular
‚úÖ **Investigue causas raiz** - Corrija a fonte, n√£o apenas sintomas
‚úÖ **Documente exce√ß√µes** - Algum drift pode ser aceit√°vel

‚ùå **N√£o corrija automaticamente sem revisar** - Revise relat√≥rios de drift primeiro
‚ùå **N√£o ignore avisos** - Drift pequeno se torna problemas grandes

### 4. Gerenciamento de Depend√™ncias

‚úÖ **Documente depend√™ncias** - Mantenha grafo de depend√™ncias atualizado
‚úÖ **Versione depend√™ncias** - Fixe em vers√µes espec√≠ficas
‚úÖ **Verifique ciclos regularmente** - Previna depend√™ncias circulares
‚úÖ **Planeje ordem de execu√ß√£o** - Use comando `deps order`

‚ùå **N√£o crie acoplamento forte** - Minimize depend√™ncias
‚ùå **N√£o pule valida√ß√£o de depend√™ncias** - Sempre valide primeiro

### 5. Valida√ß√£o

‚úÖ **Valide antes da execu√ß√£o** - Capture erros cedo
‚úÖ **Habilite modo estrito em produ√ß√£o** - Nenhum warning permitido
‚úÖ **Inclua no CI/CD** - Valide em cada commit
‚úÖ **Corrija erros de valida√ß√£o imediatamente** - N√£o ignore

‚ùå **N√£o pule valida√ß√£o** - Mesmo para "mudan√ßas r√°pidas"
‚ùå **N√£o ignore warnings** - Trate warnings como erros

---

## Casos de Uso

### Pipelines CI/CD

```bash
# Adquirir bloqueio
sloth-runner stack lock acquire production \
    --reason "Pipeline CI/CD #$BUILD_NUMBER" \
    --locked-by "ci-bot"

# Validar antes da implanta√ß√£o
sloth-runner stack validate production

# Criar snapshot pr√©-implanta√ß√£o
sloth-runner stack snapshot create production \
    --description "Antes da implanta√ß√£o #$BUILD_NUMBER" \
    --tags "ci,deployment"

# Executar implanta√ß√£o
sloth-runner run deploy --file deploy.sloth \
    --stack production \
    --validate

# Verificar drift
sloth-runner stack drift detect production

# Liberar bloqueio
sloth-runner stack lock release production \
    --unlocked-by "ci-bot"
```

### Gerenciamento Multi-Ambiente

```bash
# Obter ordem de execu√ß√£o
sloth-runner stack deps order \
    dev-network dev-db dev-app \
    staging-network staging-db staging-app \
    prod-network prod-db prod-app

# Executar em ordem com valida√ß√£o
for env in dev staging prod; do
    sloth-runner stack validate ${env}-network
    sloth-runner run deploy --file network.sloth --stack ${env}-network

    sloth-runner stack validate ${env}-db
    sloth-runner run deploy --file db.sloth --stack ${env}-db

    sloth-runner stack validate ${env}-app
    sloth-runner run deploy --file app.sloth --stack ${env}-app
done
```

### Rollback de Emerg√™ncia

```bash
# Encontrar √∫ltimo snapshot bom
sloth-runner stack snapshot list production | grep "working"

# Restaurar para √∫ltimo estado conhecido bom
sloth-runner stack snapshot restore production v35

# Verificar restaura√ß√£o
sloth-runner stack show production

# Criar snapshot de incidente
sloth-runner stack snapshot create production \
    --description "Restaura√ß√£o p√≥s-incidente" \
    --tags "incident,rollback"
```

---

## Solu√ß√£o de Problemas

### Bloqueio Travado

**Problema**: Bloqueio n√£o libera normalmente

**Solu√ß√£o**:
```bash
# Verificar status do bloqueio
sloth-runner stack lock status my-stack

# Se processo estiver morto, liberar for√ßadamente
sloth-runner stack lock force-release my-stack \
    --reason "Processo terminado, bloqueio travado"

# Verificar libera√ß√£o
sloth-runner stack lock status my-stack
```

### Falha na Restaura√ß√£o de Snapshot

**Problema**: Opera√ß√£o de restaura√ß√£o falha

**Solu√ß√£o**:
```bash
# Verificar integridade do snapshot
sloth-runner stack snapshot show my-stack v38

# Tentar dry-run primeiro
sloth-runner stack snapshot restore my-stack v38 --dry-run

# Verificar espa√ßo em disco
df -h /etc/sloth-runner

# Tentar restaura√ß√£o novamente com sa√≠da verbose
sloth-runner stack snapshot restore my-stack v38 --verbose
```

### Erros de Corre√ß√£o Autom√°tica de Drift

**Problema**: Corre√ß√£o autom√°tica falha ao corrigir drift

**Solu√ß√£o**:
```bash
# Obter relat√≥rio detalhado de drift
sloth-runner stack drift show my-stack

# Tentar dry-run para ver plano de corre√ß√£o
sloth-runner stack drift fix my-stack --dry-run

# Corrigir um recurso por vez
sloth-runner stack drift fix my-stack \
    --resource web-server

# Interven√ß√£o manual se necess√°rio
# (siga corre√ß√µes sugeridas do relat√≥rio de drift)
```

### Depend√™ncia Circular

**Problema**: Depend√™ncia circular detectada

**Solu√ß√£o**:
```bash
# Mostrar grafo de depend√™ncias
sloth-runner stack deps graph my-stack

# Verificar ciclos
sloth-runner stack deps check my-stack

# Op√ß√µes de resolu√ß√£o:
# 1. Remover depend√™ncia desnecess√°ria
# 2. Introduzir stack intermedi√°rio
# 3. Refatorar para quebrar ciclo
```

---

## Status de Testes

### Resultados dos Testes

**Testes Automatizados**: 34 testes (97% de aprova√ß√£o)
**Testes Manuais**: 65 testes no total
- Stack/Sysadmin: 26 testes (100%)
- CLI Completo: 39 testes (97.4%)

**Geral**: 98% de taxa de sucesso (97/99 testes aprovados)

### Recursos Validados

‚úÖ Ciclo de adquirir/liberar bloqueio
‚úÖ Persist√™ncia de bloqueio atrav√©s de reinicializa√ß√µes
‚úÖ Cria√ß√£o e restaura√ß√£o de snapshot
‚úÖ Gerenciamento de vers√£o (37+ vers√µes)
‚úÖ Detec√ß√£o e corre√ß√£o de drift
‚úÖ Rastreamento de depend√™ncias
‚úÖ Sistema de valida√ß√£o
‚úÖ Integra√ß√£o do sistema de eventos
‚úÖ Schema e migra√ß√µes do banco
‚úÖ Comandos CLI e sa√≠da

---

## Guia de Migra√ß√£o

### Do Terraform

Usu√°rios de Terraform encontrar√£o conceitos familiares:

| Terraform | Sloth Runner | Notas |
|-----------|--------------|-------|
| `terraform.tfstate` | Estado de stack no SQLite | Mais estruturado |
| Bloqueio de Estado (S3/DynamoDB) | Bloqueio integrado | Sem depend√™ncias externas |
| `terraform plan` | `stack validate` + `drift detect` | Verifica√ß√µes pr√©-execu√ß√£o |
| `terraform apply` | Execu√ß√£o de workflow com auto-lock | Seguran√ßa autom√°tica |
| Workspace | Stack | Conceito similar de isolamento |
| Backend | Banco de dados SQLite | Mais simples, local-first |

### Do Pulumi

Usu√°rios de Pulumi v√£o apreciar:

| Pulumi | Sloth Runner | Notas |
|--------|--------------|-------|
| Snapshots de estado | Snapshots de stack | Mesmo conceito |
| Sa√≠das de stack | Sa√≠das de stack | API compat√≠vel |
| Pulumi.yaml | Defini√ß√£o de workflow | Baseado em DSL |
| Policy packs | Sistema de valida√ß√£o | Verifica√ß√µes pr√©-execu√ß√£o |
| Secrets | Valores sens√≠veis | Armazenamento criptografado |

---

## Roadmap

### Recursos Planejados

- **Backend de estado remoto** (S3, GCS, Azure Blob)
- **Criptografia de estado em repouso**
- **Bloqueio distribu√≠do** (Redis/etcd)
- **Web UI para visualiza√ß√£o de estado**
- **Compatibilidade de importa√ß√£o do Terraform**
- **Integra√ß√£o GitOps** (sincroniza√ß√£o autom√°tica do Git)
- **Remedia√ß√£o avan√ßada de drift**
- **Replica√ß√£o multi-regi√£o**

---

## Suporte

**Documenta√ß√£o**: https://docs.sloth-runner.io
**Issues no GitHub**: https://github.com/chalkan3-sloth/sloth-runner/issues
**C√≥digo Fonte**: `cmd/sloth-runner/commands/stack/`
**Resultados de Testes**: `/tmp/SISTEMA_100_FUNCIONAL.md`

---

*√öltima Atualiza√ß√£o: 2025-10-10*
*Vers√£o: 1.0.0*
*Status: Pronto para Produ√ß√£o*
