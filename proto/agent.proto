syntax = "proto3";

package agent;

option go_package = "github.com/chalkan3-sloth/sloth-runner/proto";

service Agent {
  rpc ExecuteTask(ExecuteTaskRequest) returns (ExecuteTaskResponse);
  rpc RunCommand(RunCommandRequest) returns (stream StreamOutputResponse); // Changed to stream
  rpc Shutdown(ShutdownRequest) returns (ShutdownResponse);
}

message ShutdownRequest {}

message ShutdownResponse {}

message ExecuteTaskRequest {
  string task_name = 1;
  string task_group = 2;
  string lua_script = 3;
  bytes workspace = 4;
  string user = 5; // User to run the task as (default: root)
}

message ExecuteTaskResponse {
  bool success = 1;
  string output = 2;
  bytes workspace = 3;
}

message RegisterAgentRequest {
  string agent_name = 1;
  string agent_address = 2;
}

message RegisterAgentResponse {
  bool success = 1;
  string message = 2;
}

message AgentInfo {
  string agent_name = 1;
  string agent_address = 2;
  int64 last_heartbeat = 3; // Unix timestamp of the last heartbeat
  string status = 4;
  int64 last_info_collected = 5; // Unix timestamp of the last system info collection
  string system_info_json = 6; // JSON string with system information
}

message ListAgentsRequest {
  // No fields needed for now
}

message ListAgentsResponse {
  repeated AgentInfo agents = 1;
}

message StopAgentRequest {
  string agent_name = 1;
}

message StopAgentResponse {
  bool success = 1;
  string message = 2;
}

message UnregisterAgentRequest {
  string agent_name = 1;
}

message UnregisterAgentResponse {
  bool success = 1;
  string message = 2;
}

message ExecuteCommandRequest {
  string agent_name = 1;
  string command = 2;
}

message RunCommandRequest {
  string command = 1;
  string user = 2; // User to run the command as (default: root)
}

// New message for streaming output
message StreamOutputResponse {
  string stdout_chunk = 1;
  string stderr_chunk = 2;
  bool finished = 3;
  int32 exit_code = 4;
  string error = 5;
}

service AgentRegistry {
  rpc RegisterAgent(RegisterAgentRequest) returns (RegisterAgentResponse);
  rpc ListAgents(ListAgentsRequest) returns (ListAgentsResponse);
  rpc StopAgent(StopAgentRequest) returns (StopAgentResponse);
  rpc UnregisterAgent(UnregisterAgentRequest) returns (UnregisterAgentResponse);
  rpc ExecuteCommand(ExecuteCommandRequest) returns (stream StreamOutputResponse); // Changed to stream
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  rpc GetAgentInfo(GetAgentInfoRequest) returns (GetAgentInfoResponse);
}

message HeartbeatRequest {
  string agent_name = 1;
  string system_info_json = 2; // Optional: agent can send system info with heartbeat
}

message HeartbeatResponse {
  bool success = 1;
  string message = 2;
}

message GetAgentInfoRequest {
  string agent_name = 1;
}

message GetAgentInfoResponse {
  bool success = 1;
  string message = 2;
  AgentInfo agent_info = 3;
}