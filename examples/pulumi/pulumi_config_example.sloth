-- Complete Pulumi Workflow Example with Git Clone and Preview
-- This example shows the complete workflow: Clone -> Configure -> Preview

local clone_repo_task = task("clone_go_droplet_repo")
    :description("Clone the Go DigitalOcean droplet repository")
    :workdir("/tmp/pulumi-project")
    :command(function(this, params)
        local workdir_ensured = this.workdir.ensure()
        if not workdir_ensured then 
          return false, "Workdir problem"
        end 

        local git = require("git")
        
        log.info("📡 Cloning Go DigitalOcean droplet repository...")
        
        local git_repository = git.clone(
            "https://github.com/chalkan3/go-do-droplet",
            this.workdir.get()
        )
        
        log.info("✅ Repository cloned successfully!")
        log.info("📊 Repo object: " .. tostring(git_repository))
            
        return true, "Git clone successful", { 
            git_module_used = true,
            repository_url = "https://github.com/chalkan3/go-do-droplet",
            clone_destination = this.workdir.get()
        }
    end)
    :timeout("5m")
    :on_success(function(this, params, output)
        log.info("✅ === CLONE SUCCESS ===")
        log.info("Repository available at: " .. output.clone_destination)
    end)
    :on_fail(function(this, params, output)
        log.error("❌ Clone failed, cleaning up...")
        this.workdir:cleanup()
    end)
    :build()

local setup_pulumi_config = task("setup_pulumi_config")
    :description("Setup Pulumi configuration for DigitalOcean droplet")
    :workdir("/tmp/pulumi-project")
    :command(function(this, params)
        log.info("🔧 Setting up Pulumi configuration...")
        
        local pulumi = require("pulumi")
        
        -- Login to local backend (equivalent to: pulumi login file://.)
        log.info("🔐 Pulumi login (local backend)...")
        local client = pulumi.login("file://.", { login_local = true })
        
        if client.error then
            log.error("❌ Pulumi login failed: " .. client.error)
            return false, "Login failed"
        end
        
        log.info("✅ Pulumi login successful")
        
        -- Set working directory to the cloned repository
        client:set_workdir(this.workdir:get())
        
        -- Setup stack (equivalent to: pulumi stack init dev)
        log.info("📋 Setting up Pulumi stack...")
        local stack_success, stack_msg = client:stack("dev", { create = true })
        if not stack_success then
            log.error("❌ Stack setup failed: " .. stack_msg)
            return false, "Stack setup failed"
        end
        
        log.info("✅ Stack 'dev' ready")
        
        -- Set configuration values (equivalent to pulumi config set commands)
        log.info("⚙️ Setting Pulumi configuration values...")
        
        local configs = {
            { key = "dropletName", value = "sloth-runner" },          -- pulumi config set dropletName sloth-runner
            { key = "region", value = "nyc3" },                      -- pulumi config set region nyc3
            { key = "size", value = "s-1vcpu-1gb" },                 -- pulumi config set size s-1vcpu-1gb
            { key = "image", value = "ubuntu-22-04-x64" },           -- pulumi config set image ubuntu-22-04-x64
            { key = "environment", value = "dev" },                  -- pulumi config set environment dev
            { key = "project", value = "main" }                      -- pulumi config set project main
        }
        
        for _, config in ipairs(configs) do
            log.info("Setting: " .. config.key .. " = " .. config.value)
            local success, msg = client:set_config(config.key, config.value)
            
            if success then
                log.info("  ✅ " .. config.key .. ": " .. config.value)
            else
                log.error("  ❌ Failed to set " .. config.key .. ": " .. msg)
                return false, "Configuration failed"
            end
        end
        
        -- Verify configuration by reading back values
        log.info("🔍 Verifying configuration...")
        for _, config in ipairs(configs) do
            local value, err = client:get_config(config.key)
            if err then
                log.warn("  ⚠️ Could not read " .. config.key .. ": " .. err)
            else
                log.info("  ✅ " .. config.key .. " = " .. (value or ""))
            end
        end

        local preview_success, preview_output = client:preview({ envs = { PULUMI_CONFIG_PASSPHRASE = "", DIGITALOCEAN_TOKEN = "" }})
        
        if preview_success then
            log.info("📊 === PULUMI PREVIEW OUTPUT ===")
            log.print(preview_output)
            log.info("📊 === END PREVIEW OUTPUT ===")
            
            return true, "Preview completed successfully", {
                preview_successful = true,
                has_changes = string.find(preview_output, "create") ~= nil or 
                             string.find(preview_output, "update") ~= nil or
                             string.find(preview_output, "delete") ~= nil,
                output_length = string.len(preview_output)
            }
        else
            log.error("❌ Pulumi preview failed:")
            log.error(preview_output)
            return false, "Preview failed", {
                preview_successful = false,
                error = preview_output
            }
        end
        
    end)
    :timeout("5m")
    :on_success(function(this, params, output)
        log.info("🎉 === PULUMI CONFIGURATION SUCCESS ===")
        log.info("Stack: dev")
        log.info("Backend: local (file://)")
    end)
    :on_fail(function(this, params, output)
       this.workdir:cleanup()
    end)
    :build()


workflow.define("pulumi_complete_example")
    :description("Complete Pulumi workflow: Clone -> Configure -> Preview")
    :version("1.0.0")
    :tasks({ clone_repo_task, setup_pulumi_config})
    :config({
        timeout = "20m",
        max_parallel_tasks = 1
    })
    :on_complete(function(success, results)
        log.info("🎉 === COMPLETE PULUMI WORKFLOW COMPLETED ===")
        return true
    end)