-- Test 01: File Watcher - Created, Changed, Deleted
-- Este teste valida que file watchers detectam cria√ß√£o, modifica√ß√£o e dele√ß√£o de arquivos

workflow("file_watcher_test")
    :description("Test file watcher with create, change, delete events")
    :tasks({
        task("setup_and_test")
            :delegate_to("lady-guica")
            :shell([[
                echo "üß™ Test 01: File Watcher - Create/Change/Delete"
                echo "=============================================="

                # Limpar arquivo de teste se existir
                rm -f /tmp/watcher_test_file.txt

                echo "‚úì Setup complete"
            ]])
            :on_complete(function()
                print("üìù Registering file watcher...")

                -- Registrar watcher para o arquivo de teste
                local watcher_id = watcher.register.file({
                    file_path = '/tmp/watcher_test_file.txt',
                    when = {'created', 'changed', 'deleted'},
                    check_hash = true,
                    interval = '2s'
                })

                print("‚úì File watcher registered: " .. watcher_id)
                print("‚è≥ Watcher will monitor: /tmp/watcher_test_file.txt")
                print("‚è≥ Checking every 2 seconds for: created, changed, deleted")
            end),

        task("trigger_events")
            :delegate_to("lady-guica")
            :depends_on("setup_and_test")
            :shell([[
                echo ""
                echo "üîÑ Triggering file events..."
                echo "----------------------------"

                # Esperar watchers serem registrados
                sleep 3

                # Evento 1: CREATE
                echo "1Ô∏è‚É£  Creating file..."
                echo "Initial content" > /tmp/watcher_test_file.txt
                sleep 3

                # Evento 2: CHANGE
                echo "2Ô∏è‚É£  Modifying file..."
                echo "Modified content" >> /tmp/watcher_test_file.txt
                sleep 3

                # Evento 3: DELETE
                echo "3Ô∏è‚É£  Deleting file..."
                rm -f /tmp/watcher_test_file.txt
                sleep 3

                echo ""
                echo "‚úÖ All file events triggered"
                echo "‚è≥ Wait 10 seconds and check agent logs for events"
            ]])
    })
