-- Exemplo AvanÃ§ado do MÃ³dulo PKG - VersÃ£o 3.0
-- Demonstra todas as funcionalidades avanÃ§adas

local pkg = require("pkg")

local check_manager = task("check_manager")
	:description("Identifica o gerenciador de pacotes do sistema")
	:command(function(this, params)
		log.info("ğŸ” Identificando gerenciador de pacotes...")

		local manager, err = pkg.get_manager()

		if manager then
			log.info("âœ… Gerenciador detectado: " .. manager)
			return true, "Manager: " .. manager
		else
			log.error("âŒ Erro: " .. (err or "desconhecido"))
			return false, "Erro"
		end
	end)
	:timeout("10s")
	:build()

local check_installed = task("check_installed")
	:description("Verifica se pacotes especÃ­ficos estÃ£o instalados")
	:command(function(this, params)
		log.info("ğŸ“¦ Verificando pacotes instalados...")

		local packages_to_check = { "curl", "wget", "git", "vim" }
		local installed = {}
		local not_installed = {}

		for _, pkg_name in ipairs(packages_to_check) do
			local is_inst, msg = pkg.is_installed(pkg_name)

			if is_inst then
				table.insert(installed, pkg_name)
				log.info("  âœ… " .. pkg_name .. " - instalado")
			else
				table.insert(not_installed, pkg_name)
				log.info("  âŒ " .. pkg_name .. " - nÃ£o instalado")
			end
		end

		log.info("\nğŸ“Š Resumo:")
		log.info("  Instalados: " .. #installed)
		log.info("  NÃ£o instalados: " .. #not_installed)

		return true, #installed .. "/" .. #packages_to_check .. " instalados"
	end)
	:depends_on({ "check_manager" })
	:timeout("60s")
	:build()

local find_executables = task("find_executables")
	:description("Encontra o caminho de executÃ¡veis")
	:command(function(this, params)
		log.info("ğŸ” Procurando executÃ¡veis...")

		local executables = { "bash", "sh", "git", "curl" }

		for _, exec_name in ipairs(executables) do
			local path, err = pkg.which(exec_name)

			if path then
				log.info("  âœ… " .. exec_name .. " â†’ " .. path)
			else
				log.info("  âŒ " .. exec_name .. " â†’ nÃ£o encontrado")
			end
		end

		return true, "Busca concluÃ­da"
	end)
	:timeout("30s")
	:build()

local check_versions = task("check_versions")
	:description("Verifica versÃµes de pacotes instalados")
	:command(function(this, params)
		log.info("ğŸ“Œ Verificando versÃµes...")

		local packages = { "curl", "git" }

		for _, pkg_name in ipairs(packages) do
			log.info("\nğŸ“¦ " .. pkg_name .. ":")
			local version, err = pkg.version(pkg_name)

			if version then
				log.info("  " .. version)
			else
				log.warn("  VersÃ£o nÃ£o disponÃ­vel")
			end
		end

		return true, "VersÃµes verificadas"
	end)
	:depends_on({ "check_installed" })
	:timeout("60s")
	:build()

local check_dependencies = task("check_dependencies")
	:description("Mostra dependÃªncias de pacotes")
	:command(function(this, params)
		log.info("ğŸ”— Verificando dependÃªncias...")

		local success, deps = pkg.deps("curl")

		if success then
			log.info("âœ… DependÃªncias de curl:")

			local count = 0
			for line in deps:gmatch("[^\r\n]+") do
				if count < 10 then
					log.info("  " .. line)
				end
				count = count + 1
			end

			if count > 10 then
				log.info("  ... e mais " .. (count - 10) .. " dependÃªncias")
			end

			return true, count .. " dependÃªncias"
		else
			log.warn("âš ï¸  NÃ£o foi possÃ­vel listar dependÃªncias")
			return true, "OK"
		end
	end)
	:timeout("60s")
	:build()

local cleanup_system = task("cleanup_system")
	:description("Limpa cache e pacotes desnecessÃ¡rios")
	:command(function(this, params)
		log.info("ğŸ§¹ Limpando sistema...")

		-- Limpa cache
		log.info("\nğŸ“¦ Limpando cache de pacotes...")
		local success, output = pkg.clean()

		if success then
			log.info("  âœ… Cache limpo")
		else
			log.warn("  âš ï¸  " .. output)
		end

		-- Remove pacotes nÃ£o utilizados
		log.info("\nğŸ—‘ï¸  Removendo pacotes nÃ£o utilizados...")
		success, output = pkg.autoremove()

		if success then
			log.info("  âœ… Pacotes removidos")
			if output and output ~= "" then
				log.debug("  " .. output)
			end
		else
			log.warn("  âš ï¸  " .. output)
		end

		return true, "Limpeza concluÃ­da"
	end)
	:timeout("180s")
	:build()

local system_summary = task("system_summary")
	:description("Gera resumo do sistema")
	:command(function(this, params)
		log.info("\n")
		log.info(string.rep("=", 60))
		log.info("ğŸ“Š RESUMO DO SISTEMA DE PACOTES")
		log.info(string.rep("=", 60))

		-- Manager
		local manager, _ = pkg.get_manager()
		log.info("\nğŸ”§ Gerenciador: " .. (manager or "desconhecido"))

		-- Total de pacotes
		local success, packages = pkg.list()
		if success and type(packages) == "table" then
			local count = 0
			for _ in pairs(packages) do
				count = count + 1
			end
			log.info("ğŸ“¦ Pacotes instalados: " .. count)
		end

		-- Ferramentas importantes
		log.info("\nğŸ› ï¸  Ferramentas importantes:")
		local tools = { "git", "curl", "wget", "vim" }
		for _, tool in ipairs(tools) do
			local is_inst = pkg.is_installed(tool)
			if is_inst then
				local path = pkg.which(tool)
				log.info("  âœ… " .. tool .. " (" .. (path or "N/A") .. ")")
			else
				log.info("  âŒ " .. tool .. " (nÃ£o instalado)")
			end
		end

		log.info("\n" .. string.rep("=", 60))
		log.info("")

		return true, "Resumo gerado"
	end)
	:depends_on({ "cleanup_system" })
	:timeout("60s")
	:build()

workflow
	.define("advanced_package_management")
	:description("Gerenciamento AvanÃ§ado de Pacotes - PKG 3.0")
	:version("3.0.0")
	:tasks({
		check_manager,
		check_installed,
		find_executables,
		check_versions,
		check_dependencies,
		cleanup_system,
		system_summary,
	})
	:config({
		timeout = "15m",
		max_parallel_tasks = 1,
	})
	:on_complete(function(success, results)
		if success then
			log.info("\nğŸ‰ AnÃ¡lise completa do sistema de pacotes concluÃ­da!")
		else
			log.error("\nâŒ Falha na anÃ¡lise do sistema")
		end
		return true
	end)
