-- ğŸš€ Exemplo de uso do agente Vagrant com delegate_to
-- Este script demonstra como executar tarefas no agente mariguica (Vagrant)

print("ğŸ¯ Exemplo: Executando tarefas no agente Vagrant")
print("")

-- Tarefa 1: InformaÃ§Ãµes do sistema
local task_info_sistema = task("info_sistema_vagrant")
	:delegate_to("mariguica")
	:command(function(this, params)
		local exec = require("exec")

		print("ğŸ“Š Coletando informaÃ§Ãµes do sistema...")

		-- Kernel
		local kernel = exec.run("uname -r")
		print("Kernel:", kernel.stdout:gsub("\n", ""))

		-- Arquitetura
		local arch = exec.run("uname -m")
		print("Arquitetura:", arch.stdout:gsub("\n", ""))

		-- Hostname
		local hostname = exec.run("uname -n")
		print("Hostname:", hostname.stdout:gsub("\n", ""))

		-- Uptime
		local uptime = exec.run("cat /proc/uptime")
		local uptime_seconds = uptime.stdout:match("^(%d+)")
		print("Uptime:", math.floor(uptime_seconds / 60), "minutos")

		return { success = true }
	end)
	:build()

-- Tarefa 2: Listar processos
local task_processos = task("listar_processos")
	:delegate_to("mariguica")
	:depends_on({ task_info_sistema })
	:command(function(this, params)
		local exec = require("exec")

		print("")
		print("ğŸ” Processos rodando no container:")

		local result = exec.run("ps aux | head -10")
		print(result.stdout)

		return { success = true }
	end)
	:build()

-- Tarefa 3: InformaÃ§Ãµes de memÃ³ria
local task_memoria = task("info_memoria")
	:delegate_to("mariguica")
	:depends_on({ task_info_sistema })
	:command(function(this, params)
		local exec = require("exec")

		print("")
		print("ğŸ’¾ InformaÃ§Ãµes de MemÃ³ria:")

		local result = exec.run("free -h")
		print(result.stdout)

		return { success = true }
	end)
	:build()

-- Tarefa 4: InformaÃ§Ãµes de disco
local task_disco = task("info_disco")
	:delegate_to("mariguica")
	:depends_on({ task_info_sistema })
	:command(function(this, params)
		local exec = require("exec")

		print("")
		print("ğŸ’¿ InformaÃ§Ãµes de Disco:")

		local result = exec.run("df -h /")
		print(result.stdout)

		return { success = true }
	end)
	:build()

-- Tarefa 5: VariÃ¡veis de ambiente
local task_env = task("variaveis_ambiente")
	:delegate_to("mariguica")
	:command(function(this, params)
		local exec = require("exec")

		print("")
		print("ğŸŒ VariÃ¡veis de Ambiente Importantes:")

		local result = exec.run("env | grep -E '(PATH|HOME|USER|SHELL|LANG)' | sort")
		print(result.stdout)

		return { success = true }
	end)
	:build()

-- Tarefa 6: Teste de conectividade
local task_conectividade = task("teste_conectividade")
	:delegate_to("mariguica")
	:command(function(this, params)
		local exec = require("exec")

		print("")
		print("ğŸŒ Teste de Conectividade:")

		-- Testar conexÃ£o com o host (Mac)
		print("  Testando conexÃ£o com o host...")
		local ping = exec.run("ping -c 2 -W 1 host.docker.internal 2>&1 || echo 'Host nÃ£o acessÃ­vel'")

		if ping.stdout:find("2 packets") then
			print("  âœ… Host acessÃ­vel!")
		else
			print("  âš ï¸ Host nÃ£o acessÃ­vel")
		end

		return { success = true }
	end)
	:build()

-- Executar todas as tarefas
print("")
print("=" .. string.rep("=", 60))
print("Iniciando execuÃ§Ã£o das tarefas...")
print("=" .. string.rep("=", 60))
print("")

-- Executar tarefas em paralelo (onde possÃ­vel)
task_info_sistema:run()
task_processos:run()
task_memoria:run()
task_disco:run()
task_env:run()
task_conectividade:run()

print("")
print("=" .. string.rep("=", 60))
print("âœ… Todas as tarefas concluÃ­das!")
print("=" .. string.rep("=", 60))
print("")
print("ğŸ’¡ Dica: Este exemplo demonstra como:")
print("  â€¢ Usar :delegate_to() para executar tarefas remotamente")
print("  â€¢ Usar :depends_on() para criar dependÃªncias entre tarefas")
print("  â€¢ Executar comandos shell no agente remoto")
print("  â€¢ Processar a saÃ­da dos comandos em Lua")
print("")
