-- Teste simples do m√≥dulo pkg melhorado

local pkg = require("pkg")

workflow({
    name = "test_pkg_module",
    description = "Testa o m√≥dulo pkg melhorado",
    tasks = {
        {
            name = "test_search",
            description = "Testa busca de pacotes",
            timeout = "60s",
            run = function()
                log.info("üîç Testando busca de pacotes...")

                local success, output = pkg.search("curl")

                if success then
                    log.info("‚úÖ Busca funcionou!")
                    local lines = 0
                    for _ in output:gmatch("[^\r\n]+") do
                        lines = lines + 1
                    end
                    log.info("üìã Encontrados " .. lines .. " resultados")
                    return {changed = false, message = "Busca OK"}
                else
                    log.error("‚ùå Busca falhou: " .. output)
                    return {failed = true, message = "Busca falhou"}
                end
            end
        },
        {
            name = "test_info",
            description = "Testa informa√ß√µes de pacote",
            timeout = "30s",
            run = function()
                log.info("‚ÑπÔ∏è  Testando informa√ß√µes de pacote...")

                local success, output = pkg.info("curl")

                if success then
                    log.info("‚úÖ Info funcionou!")
                    local lines = 0
                    for line in output:gmatch("[^\r\n]+") do
                        if lines < 5 then
                            log.info("  " .. line)
                        end
                        lines = lines + 1
                    end
                    return {changed = false, message = "Info OK"}
                else
                    log.error("‚ùå Info falhou: " .. output)
                    return {failed = true, message = "Info falhou"}
                end
            end
        },
        {
            name = "test_list",
            description = "Testa listagem de pacotes",
            timeout = "60s",
            run = function()
                log.info("üìã Testando listagem de pacotes...")

                local success, packages = pkg.list()

                if success then
                    log.info("‚úÖ Listagem funcionou!")
                    if type(packages) == "table" then
                        local count = 0
                        for _ in pairs(packages) do
                            count = count + 1
                        end
                        log.info("üì¶ Total de pacotes: " .. count)
                    end
                    return {changed = false, message = "Listagem OK"}
                else
                    log.error("‚ùå Listagem falhou")
                    return {failed = true, message = "Listagem falhou"}
                end
            end
        }
    }
})