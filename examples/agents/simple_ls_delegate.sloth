-- üöÄ EXEMPLO SIMPLES: delegate_to funcionando (MODERN DSL)
-- Este exemplo usa o formato Modern DSL que funciona com agentes remotos

workflow({
    name = "remote_ls_demo",
    description = "Demo LS em agentes remotos usando delegate_to",
    tasks = {
        -- Task 1: LS no ladyguica
        {
            name = "ls_ladyguica",
            description = "Lista arquivos no agente ladyguica",
            delegate_to = "ladyguica",
            timeout = "30s",
            run = function()
                log.info("üîç Executando LS no ladyguica...")

                -- Pegar hostname primeiro
                local hostname_out, _, hostname_failed = exec.run("hostname")
                local hostname = hostname_out and hostname_out:gsub("\n", "") or "desconhecido"

                log.info("üìç Host: " .. hostname)

                -- Executar ls
                local ls_out, ls_err, ls_failed = exec.run("ls -la $HOME")

                if not ls_failed then
                    log.info("‚úÖ LS executado com sucesso no " .. hostname)
                    log.info("üìÇ Arquivos:\n" .. (ls_out or "vazio"))
                    return {changed = false, message = "LS OK no " .. hostname}
                else
                    log.error("‚ùå LS falhou no " .. hostname)
                    log.error("Erro: " .. (ls_err or "desconhecido"))
                    return {failed = true, message = "LS falhou no " .. hostname}
                end
            end
        },

        -- Task 2: LS no keiteguica
        {
            name = "ls_keiteguica",
            description = "Lista arquivos no agente keiteguica",
            delegate_to = "keiteguica",
            timeout = "30s",
            run = function()
                log.info("üîç Executando LS no keiteguica...")

                -- Pegar hostname primeiro
                local hostname_out, _, hostname_failed = exec.run("hostname")
                local hostname = hostname_out and hostname_out:gsub("\n", "") or "desconhecido"

                log.info("üìç Host: " .. hostname)

                -- Executar ls
                local ls_out, ls_err, ls_failed = exec.run("ls -la $HOME")

                if not ls_failed then
                    log.info("‚úÖ LS executado com sucesso no " .. hostname)
                    log.info("üìÇ Arquivos:\n" .. (ls_out or "vazio"))
                    return {changed = false, message = "LS OK no " .. hostname}
                else
                    log.error("‚ùå LS falhou no " .. hostname)
                    log.error("Erro: " .. (ls_err or "desconhecido"))
                    return {failed = true, message = "LS falhou no " .. hostname}
                end
            end
        }
    }
})