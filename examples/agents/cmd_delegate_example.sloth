-- Exemplo usando cmd para executar no agente remoto
-- Este exemplo cria um script .sloth temporÃ¡rio no agente e o executa via cmd

workflow({
    name = "test_cmd_execution",
    description = "Teste execuÃ§Ã£o remota via cmd",
    tasks = {
        {
            name = "run_ls_via_cmd",
            description = "Executa ls no agente via cmd",
            run = function()
                log.info("ðŸš€ Executando comando via sloth-runner no agente...")

                -- Cria um script Lua temporÃ¡rio
                local temp_script = [[
TaskDefinitions = {
    remote_ls = {
        description = "Lista arquivos",
        tasks = {
            {
                name = "list_files",
                description = "Lista HOME",
                command = function()
                    local output, err, failed = exec.run("ls -la $HOME")
                    if not failed then
                        log.info("âœ… Arquivos listados!")
                        log.info(output)
                        return true, "OK"
                    else
                        log.error("âŒ Falha: " .. (err or "erro"))
                        return false, "ERRO"
                    end
                end
            }
        }
    }
}
]]

                -- Salva o script no agente
                local script_path = "/tmp/remote_ls_" .. os.time() .. ".sloth"
                local write_cmd = "cat > " .. script_path .. " << 'EOFSCRIPT'\n" .. temp_script .. "\nEOFSCRIPT"
                local _, _, write_failed = exec.run(write_cmd)

                if write_failed then
                    log.error("âŒ Falha ao criar script temporÃ¡rio")
                    return {failed = true, message = "Erro ao criar script"}
                end

                log.info("ðŸ“ Script criado em: " .. script_path)

                -- Executa o script via sloth-runner
                local run_cmd = "sloth-runner run -f " .. script_path .. " remote_ls"
                log.info("â–¶ï¸  Executando: " .. run_cmd)

                local output, err, failed = exec.run(run_cmd)

                -- Remove o script temporÃ¡rio
                exec.run("rm -f " .. script_path)

                if not failed then
                    log.info("âœ… ExecuÃ§Ã£o via cmd bem-sucedida!")
                    log.info("ðŸ“‹ SaÃ­da:\n" .. output)
                    return {changed = true, message = "Executado com sucesso"}
                else
                    log.error("âŒ Falha na execuÃ§Ã£o: " .. (err or "erro desconhecido"))
                    return {failed = true, message = "Falha na execuÃ§Ã£o"}
                end
            end,
            delegate_to = "ladyguica",
            timeout = "60s"
        }
    }
})
