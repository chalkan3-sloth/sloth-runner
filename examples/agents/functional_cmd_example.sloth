-- ‚úÖ EXEMPLO FUNCIONAL COMPLETO - DSL Moderno com delegate_to
-- Demonstra execu√ß√£o remota usando :delegate_to() em m√∫ltiplos agentes

local check_system = task("check_system")
    :description("Verifica informa√ß√µes do sistema no agente")
    :command(function(this, params)
        log.info("‚ÑπÔ∏è  Verificando sistema no agente remoto...")
        
        local output, err, failed = exec.run("uname -a")
        
        if not failed then
            log.info("‚úÖ Sistema verificado!")
            log.info("üìã Sistema:\n" .. output)
            return true, "Sistema OK"
        else
            log.error("‚ùå Falha: " .. (err or "erro"))
            return false, "Erro"
        end
    end)
    :delegate_to("ladyguica")
    :timeout("60s")
    :build()

local hostname_remoto = task("hostname_remoto")
    :description("Mostra hostname do agente remoto")
    :command(function(this, params)
        log.info("üñ•Ô∏è  Verificando hostname...")
        
        local output, err, failed = exec.run("hostname && whoami && date")
        
        if not failed then
            log.info("‚úÖ Hostname obtido com sucesso!")
            log.info("üìã Resultado:\n" .. output)
            return true, "Hostname verificado"
        else
            log.error("‚ùå Falha: " .. (err or "erro"))
            return false, "Erro"
        end
    end)
    :delegate_to("ladyguica")
    :timeout("30s")
    :build()

local list_home_files = task("list_home_files")
    :description("Lista arquivos do HOME no agente")
    :command(function(this, params)
        log.info("üìÇ Listando arquivos no agente remoto...")
        
        local output, err, failed = exec.run("ls -lah $HOME | head -10")
        
        if not failed then
            log.info("‚úÖ Listagem realizada!")
            log.info("üìã Primeiros 10 arquivos:\n" .. output)
            return true, "Listagem OK"
        else
            log.error("‚ùå Falha: " .. (err or "erro"))
            return false, "Erro"
        end
    end)
    :delegate_to("keiteguica")
    :timeout("60s")
    :build()

workflow.define("remote_via_cmd")
    :description("Execu√ß√£o remota usando delegate_to")
    :version("1.0.0")
    :tasks({ check_system, hostname_remoto, list_home_files })
    :config({ 
        timeout = "3m",
        max_parallel_tasks = 3
    })
    :on_complete(function(success, results)
        if success then
            log.info("‚úÖ Todas as tarefas remotas executadas com sucesso!")
        else
            log.error("‚ùå Algumas tarefas falharam")
        end
        return true
    end)
