-- EXEMPLO FUNCIONANDO: delegate_to usando TaskDefinitions (Legacy)
-- Este formato é compatível com o envio para agentes remotos

workflow({
    name = "test_remote_execution",
    description = "Teste execução remota funcionando",
    tasks = {
        {
            name = "test_hostname_on_ladyguica",
            description = "Executa hostname no agente ladyguica",
            run = function()
                log.info("🚀 Executando comando remoto...")

                -- Executa comando no agente remoto
                local output, error, failed = exec.run("hostname && date && echo '✅ Comando executado no agente remoto!'")

                if not failed then
                    log.info("✅ Sucesso no agente remoto!")
                    log.info("📝 Saída: " .. output)
                    return {changed = true, message = "Comando executado com sucesso"}
                else
                    log.error("❌ Falha: " .. (error or "erro desconhecido"))
                    return {failed = true, message = "Comando falhou"}
                end
            end,
            delegate_to = "ladyguica",
            timeout = "30s"
        },
        {
            name = "test_ls_on_keiteguica",
            description = "Lista arquivos no agente keiteguica",
            run = function()
                log.info("🔍 Listando arquivos no agente remoto...")

                local output, error, failed = exec.run("ls -la $HOME && echo '📂 Listagem completa!'")

                if not failed then
                    log.info("✅ Listagem realizada com sucesso!")
                    log.info("📂 Arquivos:\n" .. output)
                    return {changed = true, message = "Listagem concluída"}
                else
                    log.error("❌ Falha na listagem: " .. (error or "erro desconhecido"))
                    return {failed = true, message = "Listagem falhou"}
                end
            end,
            delegate_to = "keiteguica",
            timeout = "30s"
        }
    }
})
