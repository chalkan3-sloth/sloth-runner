-- EXEMPLO FUNCIONAL: Execu√ß√£o remota via agent run (cmd)
-- Este exemplo usa "agent run" que j√° funciona perfeitamente

workflow({
    name = "via_cmd_remote",
    description = "Execu√ß√£o remota usando agent run (CMD)",
    tasks = {
        {
            name = "show_hostname",
            description = "Mostra hostname do agente via cmd",
            run = function()
                log.info("üöÄ Executando hostname no agente ladyguica via CMD...")

                -- Usando o bin√°rio sloth-runner diretamente
                local cmd = "sloth-runner agent run ladyguica 'hostname && whoami && date' --master 192.168.1.29:50053"
                local output, err, failed = exec.run(cmd)

                if not failed then
                    log.info("‚úÖ Comando executado com sucesso!")
                    log.info("üìã Sa√≠da:\n" .. output)
                    return {changed = true, message = "Sucesso via CMD"}
                else
                    log.error("‚ùå Falha: " .. (err or "erro desconhecido"))
                    return {failed = true, message = "Erro via CMD"}
                end
            end,
            timeout = "60s"
        },
        {
            name = "list_files",
            description = "Lista arquivos no agente via cmd",
            run = function()
                log.info("üìÇ Listando arquivos no agente keiteguica via CMD...")

                local cmd = "sloth-runner agent run keiteguica 'ls -la $HOME | head -15' --master 192.168.1.29:50053"
                local output, err, failed = exec.run(cmd)

                if not failed then
                    log.info("‚úÖ Listagem realizada com sucesso!")
                    log.info("üìã Arquivos:\n" .. output)
                    return {changed = true, message = "Listagem via CMD"}
                else
                    log.error("‚ùå Falha: " .. (err or "erro desconhecido"))
                    return {failed = true, message = "Erro na listagem"}
                end
            end,
            timeout = "60s"
        },
        {
            name = "system_info",
            description = "Coleta info do sistema via cmd",
            run = function()
                log.info("‚ÑπÔ∏è  Coletando informa√ß√µes via CMD...")

                local script = [[
echo '=== SISTEMA ==='
uname -a
echo ''
echo '=== USU√ÅRIO ==='
whoami
echo ''
echo '=== DATA ==='
date
]]

                local cmd = "sloth-runner agent run ladyguica '" .. script .. "' --master 192.168.1.29:50053"
                local output, err, failed = exec.run(cmd)

                if not failed then
                    log.info("‚úÖ Informa√ß√µes coletadas!")
                    log.info("üìã Sistema:\n" .. output)
                    return {changed = true, message = "Info via CMD"}
                else
                    log.error("‚ùå Falha: " .. (err or "erro desconhecido"))
                    return {failed = true, message = "Erro ao coletar"}
                end
            end,
            timeout = "60s"
        }
    }
})
