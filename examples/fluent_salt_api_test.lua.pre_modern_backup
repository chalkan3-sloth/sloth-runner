-- Modern DSL: [FILE_DESCRIPTION]
-- Migrated from legacy TaskDefinitions format
-- This example now uses the modern fluent API alongside legacy compatibility

-- examples/fluent_salt_api_test.lua
--
-- Este arquivo de exemplo demonstra o uso da nova API fluente do Salt.
-- Ele executa comandos em alvos específicos usando encadeamento de métodos.

-- A função 'command' é o ponto de entrada para a execução da tarefa.
command = function()
    log.info("Iniciando teste da API fluente do Salt...")

    local client = salt.client()

    -- Teste 1: Executando comandos no minion 'keiteguica'
    log.info("Testando alvo único: keiteguica")
    -- Encadeia o comando ping() para o alvo 'keiteguica'
    client:target('keiteguica', 'glob'):ping()

    log.info("--------------------------------------------------")

    -- Teste 2: Executando comandos em múltiplos minions usando globbing
    log.info("Testando alvo com glob: vm-gcp-squid-proxy*")
    -- Encadeia os comandos ping() e cmd() para alvos que correspondem ao padrão
    client:target('vm-gcp-squid-proxy*', 'glob'):ping()
    client:target('vm-gcp-squid-proxy*', 'glob'):cmd('pkg.upgrade')

    log.info("Teste da API fluente do Salt concluído.")

    log.info("Executando 'ls -la' via Salt e tratando a saída...")
    local result_stdout, result_stderr, result_err = client:target('keiteguica', 'glob'):cmd('cmd.run', 'ls -la')

    if result_err ~= nil then
        log.error("Erro ao executar 'ls -la' via Salt: " .. result_err)
        log.error("Stderr: " .. result_stderr)
    else
        log.info("Saída de 'ls -la' via Salt:")
        -- Se a saída for uma tabela (JSON), você pode iterar sobre ela ou convertê-la para string
        if type(result_stdout) == "table" then
            log.info("Saída JSON (tabela): " .. data.to_json(result_stdout))
        else
            log.info(result_stdout)
        end
    end
    log.info("Tratamento da saída de 'ls -la' via Salt concluído.")

    return true, "Comandos da API fluente do Salt e 'ls -la' executados com sucesso."
end

-- Definição da tarefa para o sloth-runner

-- TODO: Implement modern DSL version here
-- Example modern DSL structure:
--
-- local example_task = task("task_name")
--     :description("Task description with modern DSL")
--     :command(function(params, deps)
--         -- Enhanced task logic
--         return true, "Task completed", { result = "success" }
--     end)
--     :timeout("30s")
--     :build()
--
-- workflow.define("workflow_name", {
--     description = "Workflow description - Modern DSL",
--     version = "2.0.0",
--     tasks = { example_task },
--     config = { timeout = "10m" }
-- })

-- Maintain backward compatibility with legacy format
TaskDefinitions = {
    test_fluent_salt = {
        description = "Testa a nova API fluente do Salt com múltiplos alvos e comandos.",
        tasks = {
            {
                name = "run_salt_tests",
                command = command
            }
        }
    }
}
